<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ØªØ·Ø¨ÙŠÙ‚ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù†ØªØ®Ø§Ø¨Ø§Øª Ø§Ù„Ø£Ù†Ø¯ÙŠØ© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ©</title>
  <style>
    :root{
      --bg:#f4f6fb; --card:#fff; --primary1:#2563eb; --primary2:#7c3aed;
      --muted:#6b7280; --danger:#ef4444; --success:#16a34a; --shadow:0 8px 24px rgba(0,0,0,0.08);
      --radius:12px;
    }
    *{box-sizing:border-box}
    body{
      font-family: "Cairo", "Tahoma", Arial, sans-serif;
      direction: rtl;
      margin:0;
      background:var(--bg);
      color:#111827;
      -webkit-font-smoothing:antialiased;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    header{
      background: linear-gradient(135deg,var(--primary1),var(--primary2));
      color:#fff;
      padding:18px 12px;
      box-shadow:var(--shadow);
    }
    header .container{
      max-width:1200px;
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    header h1{margin:0;font-size:18px;font-weight:700}
    nav{max-width:1200px;margin:12px auto 0;display:flex;gap:0;padding:0 12px}
    .tab{
      flex:1;padding:12px;border:none;background:#fff;border-radius:10px 10px 0 0;cursor:pointer;font-weight:600;color:#374151;
      border-bottom:3px solid transparent;transition:all .18s;
    }
    .tab.active{color:var(--primary1);border-bottom-color:var(--primary1);background:#fff}
    main{
      max-width:1200px;
      margin:16px auto;
      padding:0 12px;
      flex:1;
      width:100%;
    }
    .panel{background:var(--card);padding:16px;border-radius:var(--radius);box-shadow:var(--shadow);margin-bottom:16px}
    .controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .controls select, .controls input[type="text"]{
      padding:10px;border-radius:10px;border:1px solid #e6eefc;min-width:220px;background:#fff;font-size:14px;
    }
    .controls .btn{background:linear-gradient(135deg,var(--primary1),var(--primary2));color:#fff;border:none;padding:10px 14px;border-radius:999px;cursor:pointer;font-weight:700}
    .controls .btn.secondary{background:#fff;color:var(--primary1);border:1px solid #e6eefc}
    .controls .btn.danger{background:var(--danger);color:#fff;border:1px solid var(--danger)}
    .responsive-container{width:100%;overflow-x:auto;-webkit-overflow-scrolling:touch;margin-top:12px}
    table{width:100%;border-collapse:collapse;min-width:760px;background:var(--card);border-radius:8px;overflow:hidden}
    thead th{padding:12px;background:linear-gradient(90deg,var(--primary1),var(--primary2));color:#fff;text-align:center}
    th,td{padding:10px;border-bottom:1px solid #f0f4fb;text-align:center;font-size:14px;vertical-align:middle}
    tbody tr:nth-child(even){background:#fbfdff}
    .actions button{margin:0 4px;padding:6px 10px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
    .actions .edit{background:#f59e0b;color:#000}
    .actions .delete{background:var(--danger);color:#fff}
    .actions .save{background:var(--success);color:#fff}
    .actions .cancel{background:#6b7280;color:#fff}
    .badge{display:inline-block;padding:6px 10px;border-radius:999px;background:#eef2ff;color:var(--primary1);font-weight:700}
    .conflicts-table{width:100%;border-collapse:collapse;margin-top:8px;min-width:500px}
    .conflict-type{font-weight:700;color:var(--primary2)}
    .conflict-days{font-weight:700;color:var(--danger)}
    .summary{margin-top:12px;padding:12px;border-radius:10px;background:#ecfeef;color:#064e3b; font-weight:700}
    .muted{color:var(--muted)}
    /* modal */
    .modal{display:none;position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.45);align-items:center;justify-content:center;z-index:9999}
    .modal .box{background:#fff;padding:18px;border-radius:12px;min-width:280px;max-width:480px;box-shadow:var(--shadow)}
    .modal .actions{display:flex;gap:8px;justify-content:center;margin-top:12px}
    
    /* Footer */
    footer{
      background: var(--bg);
      border-top: 1px solid #e6eefc;
      padding: 20px 12px;
      margin-top: auto;
      text-align: center;
    }
    .footer-content{
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
      color: var(--muted);
      font-size: 14px;
    }
    .footer-main{
      font-weight: 600;
      color: var(--primary1);
    }
    .footer-designed{
      font-size: 13px;
    }
    .footer-department{
      font-size: 12px;
      color: var(--muted);
    }

    /* responsive */
    @media (max-width:900px){
      .controls select, .controls input[type="text"]{min-width:160px}
    }
    @media (max-width:640px){
      header .container{flex-direction:column;gap:8px;text-align:center}
      .controls{flex-direction:column;align-items:stretch}
      .controls select, .controls input[type="text"]{width:100%}
      table{min-width:560px}
      .footer-content{
        gap: 6px;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div style="display:flex;align-items:center;gap:12px">
        <div style="width:44px;height:44px;border-radius:8px;background:#fff;display:flex;align-items:center;justify-content:center;font-weight:800;color:var(--primary1)">âš½</div>
        <h1>ØªØ·Ø¨ÙŠÙ‚ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù†ØªØ®Ø§Ø¨Ø§Øª Ø§Ù„Ø£Ù†Ø¯ÙŠØ© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ©</h1>
      </div>
      <div class="muted" style="font-size:13px">Kh Alm â€” Â© ØªØ·Ø¨ÙŠÙ‚ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù†ØªØ®Ø§Ø¨Ø§Øª Ø§Ù„Ø£Ù†Ø¯ÙŠØ© 2025 Â©  </div>
    </div>
  </header>

  <nav>
    <button class="tab active" data-tab="main-tab">Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    <button class="tab" data-tab="cycles-tab">Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ø§Ù†ØªØ®Ø§Ø¨ÙŠØ©</button>
    <button class="tab" data-tab="backup-tab">Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</button>
  </nav>

  <main>
    <!-- Main Tab -->
    <section id="main-tab" class="tab-content active">
      <div class="panel">
        <div class="controls">
          <select id="clubSelect" aria-label="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù†Ø¯ÙŠØ©">
            <option value="">-- Ø§Ø®ØªØ± Ù†Ø§Ø¯ÙŠÙ‹Ø§ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© --</option>
          </select>

          <button class="btn" onclick="addSelectedClub()">â• Ø¥Ø¶Ø§ÙØ© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>

          <div style="display:flex;gap:8px;align-items:center">
            <input id="newClubName" type="text" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ù†Ø§Ø¯ÙŠ Ø¬Ø¯ÙŠØ¯ (ÙƒØªØ§Ø¨ÙŠ)" />
            <button class="btn" onclick="addNewClubFromInput()">âœï¸ Ø¥Ø¶Ø§ÙØ© Ù†Ø§Ø¯ÙŠ Ø¬Ø¯ÙŠØ¯</button>
            <button class="btn danger" onclick="deleteFromDropdown()">ğŸ—‘ï¸ Ø­Ø°Ù Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
          </div>

          <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
            <button class="btn secondary" onclick="exportCSV()">ğŸ“Š ØªØµØ¯ÙŠØ± Excel (CSV)</button>
            <span class="badge" id="clubsCount">0 Ù†Ø§Ø¯ÙŠ</span>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="responsive-container">
          <table id="clubsTable" aria-label="Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ù†Ø¯ÙŠØ©">
            <thead>
              <tr>
                <th>Ø§Ø³Ù… Ø§Ù„Ù†Ø§Ø¯ÙŠ</th>
                <th>Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø§Ù†ØªØ®Ø§Ø¨Ø§Øª Ø§Ù„Ø£ÙˆÙ„</th>
                <th>Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø§Ù†ØªØ®Ø§Ø¨Ø§Øª Ø§Ù„Ø«Ø§Ù†ÙŠ</th>
                <th>Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªØ³Ø¯ÙŠØ¯</th>
                <th>Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªØ³Ø¯ÙŠØ¯</th>
                <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="panel">
        <h3>Ø§Ù„ØªØ¹Ø§Ø±Ø¶Ø§Øª Ø§Ù„Ù…ÙƒØªØ´ÙØ©</h3>
        <div class="responsive-container" id="conflictsContainer"></div>
      </div>
    </section>
    <!-- Election Cycles Tab -->
    <section id="cycles-tab" class="tab-content" style="display:none">
      <!-- Reconciliation Dates Section -->
      <div class="panel">
        <h3>ğŸ“… ØªÙˆØ§Ø±ÙŠØ® ØªÙˆÙÙŠÙ‚ Ø§Ù„Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© Ù„Ù„Ø£Ù†Ø¯ÙŠØ©</h3>
        <p class="muted">ØªØ§Ø±ÙŠØ® ØªÙˆÙÙŠÙ‚ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ Ù‡Ùˆ Ø§Ù„ØªØ§Ø±ÙŠØ®  Ø§Ù„Ø°ÙŠ ÙŠØ­Ø¯Ø¯ Ø¨Ø¯Ø§ÙŠØ© Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ø¥Ù†ØªØ®Ø§Ø¨ÙŠØ© Ø£ÙŠ Ø¯ÙˆØ±Ø© Ø¨Ø¯Ø£Øª Ù‚Ø¨Ù„ Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù„Ø§ ØªØ­Ø³Ø¨ Ø¶Ù…Ù† Ø§Ù„Ø«Ù„Ø§Ø« Ø¯ÙˆØ±Ø§Øª.</p>
        <div class="controls">
          <select id="clubSelectReconciliation">
            <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù†Ø§Ø¯ÙŠ --</option>
          </select>
          <input type="text" id="reconciliationDateInput" placeholder="ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙˆÙÙŠÙ‚ (ÙŠÙˆÙ…/Ø´Ù‡Ø±/Ø³Ù†Ø©)" style="min-width:200px">
          <button class="btn" onclick="setReconciliationDate()">ğŸ’¾ Ø­ÙØ¸ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙˆÙÙŠÙ‚</button>
        </div>
        
        <div class="responsive-container">
          <table id="reconciliationDatesTable">
            <thead>
              <tr>
                <th>Ø§Ù„Ù†Ø§Ø¯ÙŠ</th>
                <th>ØªØ§Ø±ÙŠØ® ØªÙˆÙÙŠÙ‚ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ</th>
                <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="panel">
        <h3>Ø¥Ø¶Ø§ÙØ© Ø±Ø¦ÙŠØ³ Ù„Ù†Ø§Ø¯ÙŠ Ø¬Ø¯ÙŠØ¯</h3>
        <div class="controls">
          <input id="presidentName" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ø±Ø¦ÙŠØ³" />
          <select id="presidentClubSelect" aria-label="Ø§Ø®ØªØ± Ø§Ù„Ù†Ø§Ø¯ÙŠ">
            <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù†Ø§Ø¯ÙŠ --</option>
          </select>
          <input id="cycleStartDate" type="text" placeholder="ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¯ÙˆØ±Ø© (ÙŠÙˆÙ…/Ø´Ù‡Ø±/Ø³Ù†Ø©)" />
          <button class="btn" onclick="addNewPresident()">â• Ø¥Ø¶Ø§ÙØ© Ø±Ø¦ÙŠØ³ Ø¬Ø¯ÙŠØ¯</button>
        </div>
      </div>

      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <h3 style="margin:0">Ø±Ø¤Ø³Ø§Ø¡ Ø§Ù„Ø£Ù†Ø¯ÙŠØ©</h3>
          <div style="display:flex;gap:8px">
            <span class="badge" id="presidentsCount">0 Ø±Ø¦ÙŠØ³</span>
            <span class="badge" style="background:#d1fae5;color:#065f46" id="eligibleCount">0 Ù…Ø¤Ù‡Ù„</span>
            <span class="badge" style="background:#fee2e2;color:#991b1b" id="ineligibleCount">0 Ù…Ù…Ù†ÙˆØ¹</span>
          </div>
        </div>
        <div class="responsive-container">
          <table id="presidentsTable" aria-label="Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±Ø¤Ø³Ø§Ø¡">
            <thead>
              <tr>
                <th>Ø§Ø³Ù… Ø§Ù„Ø±Ø¦ÙŠØ³</th>
                <th>Ø§Ø³Ù… Ø§Ù„Ù†Ø§Ø¯ÙŠ</th>
                <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙˆØ±Ø§Øª</th>
                <th>Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ù…Ø­Ø³ÙˆØ¨Ø©</th>
                <th>Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ù…ØªØªØ§Ù„ÙŠØ©</th>
                <th>Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ù‡Ù„ÙŠØ©</th>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ§Ù„ÙŠ Ù„Ù„ØªØ±Ø´Ø­</th>
                <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

          </section>

    <!-- Backup Tab -->
    <section id="backup-tab" class="tab-content" style="display:none">
      <div class="panel">
        <h3>Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</h3>
        <p class="muted">ÙŠÙ…ÙƒÙ†Ùƒ ØªØµØ¯ÙŠØ± Ø£Ùˆ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ø§Ù†ØªØ®Ø§Ø¨Ø§Øª Ø§Ù„Ø£Ù†Ø¯ÙŠØ© (JSON) ÙŠØ¯Ø¹Ù… Ù…Ù„Ù </p>
        <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:12px">
          <button class="btn" onclick="exportBackup()">ğŸ’¾ ØªØµØ¯ÙŠØ± Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>
          <button class="btn" onclick="triggerImportBackup()">ğŸ“‚ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>
          <button class="btn" onclick="clearAllData()">ğŸ§¹ Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        </div>
        <div style="margin-top:12px;color:var(--muted)">Ø¢Ø®Ø± Ù†Ø³Ø®Ø© Ù…Ø­ÙÙˆØ¸Ø©: <span id="lastBackup">-</span></div>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer>
    <div class="footer-content">
      <div class="footer-main">Â© ØªØ·Ø¨ÙŠÙ‚ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù†ØªØ®Ø§Ø¨Ø§Øª Ø§Ù„Ø£Ù†Ø¯ÙŠØ© 2025</div>
      <div class="footer-designed">Designed by Kh Alm</div>
      <div class="footer-department">Ù…Ø¯ÙŠØ±ÙŠØ© Ø´Ø¨Ø§Ø¨ Ù…Ø­Ø§ÙØ¸Ø© Ø¬Ø±Ø´</div>
    </div>
  </footer>

  <!-- Confirmation Modal -->
  <div id="confirmModal" class="modal" role="dialog" aria-hidden="true">
    <div class="box">
      <div id="confirmText">Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ</div>
      <div class="actions">
        <button class="btn secondary" onclick="closeModal(false)">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn" onclick="closeModal(true)">ØªØ£ÙƒÙŠØ¯</button>
      </div>
    </div>
  </div>

  <!-- Cycles Details Modal -->
  <div id="cyclesModal" class="modal" role="dialog" aria-hidden="true">
    <div class="box" style="max-width:700px">
      <h3 id="cyclesModalTitle" style="margin-top:0">ØªÙØ§ØµÙŠÙ„ Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³</h3>
      <div id="cyclesModalContent"></div>
      <div class="actions">
        <button class="btn secondary" onclick="closeCyclesModal()">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
  </div>

<script>
/* ================= Ø§Ù„Ø­Ø§Ù„Ø© Ùˆ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ ================= */
let clubsData = []; // {id,name,election1,election2,paymentStart,paymentEnd,editing,_backup}
let presidentsData = []; // {id,name,clubName,cycles:[{cycleNumber,startDate,endDate,status,countable}],totalCycles,countableCycles,consecutiveCycles,canNominate,nextEligibleDate}
let clubsReconciliation = {}; // {clubName: reconciliationDate}
const dropdownDefault = [
  "Ù†Ø§Ø¯ÙŠ Ø¬Ø±Ø´ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ","Ù†Ø§Ø¯ÙŠ Ø§Ù„Ø£Ù‚ØµÙ‰ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ","Ù†Ø§Ø¯ÙŠ Ù…Ø±ØµØ¹ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ","Ù†Ø§Ø¯ÙŠ Ø´Ø¨Ø§Ø¨ Ø§Ù„Ù…ØµØ·Ø¨Ø© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ",
  "Ù†Ø§Ø¯ÙŠ ÙƒÙØ±Ø®Ù„ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ","Ù†Ø§Ø¯ÙŠ Ø³Ø§ÙƒØ¨ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ","Ù†Ø§Ø¯ÙŠ Ø¥ØªØ­Ø§Ø¯ Ø¬Ø±Ø´ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ","Ù†Ø§Ø¯ÙŠ Ø§Ù„ÙƒØªØ© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ","Ù†Ø§Ø¯ÙŠ Ø´Ø¨Ø§Ø¨ Ø³ÙˆÙ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ","Ù†Ø§Ø¯ÙŠ Ø´Ø¨Ø§Ø¨ Ø±ÙŠÙ…ÙˆÙ† Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ","Ù†Ø§Ø¯ÙŠ Ø´Ø¨Ø§Ø¨ Ø§Ù„ÙÙŠØ­Ø§Ø¡ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ","Ù†Ø§Ø¯ÙŠ Ø´Ø¨Ø§Ø¨ Ù…Ø±ØµØ¹ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ","Ù†Ø§Ø¯ÙŠ Ø¬Ø¨Ø© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ","Ù†Ø§Ø¯ÙŠ Ø´Ø¨Ø§Ø¨ Ø¬Ø¨Ø© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ","Ù†Ø§Ø¯ÙŠ Ù†Ø­Ù„Ø© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ","Ù†Ø§Ø¯ÙŠ ØºØ²Ø© Ù‡Ø§Ø´Ù… Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ","Ù†Ø§Ø¯ÙŠ Ø§Ù„Ø±Ø´Ø§ÙŠØ¯Ø© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ","Ù†Ø§Ø¯ÙŠ Ù‚ÙÙ‚ÙØ§ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ"
];

/* ================= Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ================= */
document.addEventListener('DOMContentLoaded', () => {
  attachTabs();
  ensureDropdownOptions();
  loadClubsFromStorage();
  renderClubsTable();
  updateStats();
  loadReconciliationDates();
  renderReconciliationTable();
  loadPresidentsFromStorage();
  renderPresidentsTable();
  updatePresidentsStats();
  updateLastBackupDisplay();
});

/* ================= Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„ØªØ¨ÙˆÙŠØ¨ ================= */
function attachTabs(){
  document.querySelectorAll('.tab').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c=>c.style.display='none');
      btn.classList.add('active');
      const id = btn.dataset.tab;
      document.getElementById(id).style.display = 'block';
      if(id === 'backup-tab') updateLastBackupDisplay();
      if(id === 'cycles-tab') {
        populateReconciliationClubSelect();
        populatePresidentClubSelect();
        renderReconciliationTable();
        renderPresidentsTable();
        updatePresidentsStats();
      }
    });
  });
}

function ensureDropdownOptions(){
  const select = document.getElementById('clubSelect');
  while(select.options.length > 1) select.remove(1);
  const saved = localStorage.getItem('dropdownOptions');
  const list = saved ? JSON.parse(saved) : dropdownDefault;
  list.forEach(name => {
    const opt = document.createElement('option'); opt.value = name; opt.text = name; select.add(opt);
  });
  if(!saved) localStorage.setItem('dropdownOptions', JSON.stringify(list));
}
function saveDropdownOptions(arr){ try{ localStorage.setItem('dropdownOptions', JSON.stringify(arr)); }catch(e){} }
function getDropdownOptions(){
  const select = document.getElementById('clubSelect');
  const opts = [];
  for(let i=1;i<select.options.length;i++) opts.push(select.options[i].text);
  return opts;
}

// ===  Ø­Ø°Ù Ù†Ø§Ø¯ÙŠ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© ===
function deleteFromDropdown(){
  const select = document.getElementById('clubSelect');
  const selectedOption = select.options[select.selectedIndex];
  
  if(!selectedOption || selectedOption.value === ''){
    alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù†Ø§Ø¯ÙŠ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ø­Ø°ÙÙ‡');
    return;
  }
  
  const clubName = selectedOption.text;
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù†Ø§Ø¯ÙŠ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
  if(clubsData.some(c => c.name === clubName)){
    alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø§Ù„Ù†Ø§Ø¯ÙŠ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ø£Ù†Ù‡ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙŠØ±Ø¬Ù‰ Ø­Ø°ÙÙ‡ Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø£ÙˆÙ„Ø§.');
    return;
  }
  
  showModal('ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©', `Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù†Ø§Ø¯ÙŠ "${escapeHtml(clubName)}" Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©ØŸ`, ()=>{ 
    performDropdownDelete(clubName);
  });
}

function performDropdownDelete(clubName){
  const select = document.getElementById('clubSelect');
  const options = getDropdownOptions();
  const updatedOptions = options.filter(name => name !== clubName);
  
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
  while(select.options.length > 1) select.remove(1);
  updatedOptions.forEach(name => {
    const opt = document.createElement('option'); 
    opt.value = name; 
    opt.text = name; 
    select.add(opt);
  });
  
  // Ø­ÙØ¸ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
  saveDropdownOptions(updatedOptions);
  alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù†Ø§Ø¯ÙŠ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©');
}

/* ================= Ø§Ù„ØªØ®Ø²ÙŠÙ† ================= */
function saveClubsToStorage(){
  try{ const toSave = clubsData.map(c => { const {editing,_backup,...rest} = c; return rest; }); localStorage.setItem('clubs', JSON.stringify(toSave)); } catch(e){}
  updateStats();
}
function loadClubsFromStorage(){
  const s = localStorage.getItem('clubs');
  if(s){
    try{ clubsData = JSON.parse(s).map(normalizeClub); } catch(e){ clubsData = []; }
  } else clubsData = [];
}

/* ================= Ø§Ø¶Ø§ÙØ© Ù†Ø§Ø¯ÙŠ ================= */
function addSelectedClub(){
  const sel = document.getElementById('clubSelect');
  const name = sel.value;
  if(!name){ alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù†Ø§Ø¯ÙŠ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©'); return; }
  if(clubsData.some(c => c.name === name)){ alert('Ø§Ù„Ù†Ø§Ø¯ÙŠ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„'); sel.value=''; return; }
  clubsData.push({ id: Date.now()+Math.random(), name, election1:'', election2:'', paymentStart:'', paymentEnd:'', editing:false });
  saveClubsToStorage(); renderClubsTable(); sel.value=''; alert('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©');
}
function addNewClubFromInput(){
  const input = document.getElementById('newClubName');
  const name = input.value.trim();
  if(!name){ alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù†Ø§Ø¯ÙŠ'); return; }
  if(clubsData.some(c => c.name === name)){ alert('Ø§Ù„Ù†Ø§Ø¯ÙŠ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„'); input.value=''; return; }
  const select = document.getElementById('clubSelect');
  if(![...select.options].some(o => o.text === name)){
    const opt = document.createElement('option'); opt.value = name; opt.text = name; select.add(opt);
    saveDropdownOptions(getDropdownOptions());
  }
  clubsData.push({ id: Date.now()+Math.random(), name, election1:'', election2:'', paymentStart:'', paymentEnd:'', editing:false });
  saveClubsToStorage(); renderClubsTable(); input.value=''; alert('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ø§Ø¯ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯');
}

/* ================= Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ================= */
function renderClubsTable(){
  const tbody = document.querySelector('#clubsTable tbody'); tbody.innerHTML = '';
  // sort by election1 (empty last)
  clubsData.sort((a,b) => (a.election1 || '9999-99-99').localeCompare(b.election1 || '9999-99-99'));
  clubsData.forEach((club, i) => {
    const tr = document.createElement('tr');
    if(club.editing){
      tr.innerHTML = `
        <td><input type="text" value="${escapeHtml(club.name)}" oninput="clubsData[${i}].name=this.value" /></td>
        <td><input type="date" value="${club.election1||''}" onchange="onDateChange(${i},'election1',this.value)" /></td>
        <td><input type="date" value="${club.election2||''}" disabled /></td>
        <td><input type="date" value="${club.paymentStart||''}" onchange="onDateChange(${i},'paymentStart',this.value)" /></td>
        <td><input type="date" value="${club.paymentEnd||''}" disabled /></td>
        <td class="actions">
          <button class="save" onclick="saveEdit(${i})">ğŸ’¾ Ø­ÙØ¸</button>
          <button class="cancel" onclick="cancelEdit(${i})">âŒ Ø¥Ù„ØºØ§Ø¡</button>
        </td>
      `;
    } else {
      tr.innerHTML = `
        <td>${escapeHtml(club.name)}</td>
        <td>${club.election1 || ''}</td>
        <td>${club.election2 || ''}</td>
        <td>${club.paymentStart || ''}</td>
        <td>${club.paymentEnd || ''}</td>
        <td class="actions">
          <button class="edit" onclick="startEdit(${i})">âœï¸</button>
          <button class="delete" onclick="confirmDelete(${i})">ğŸ—‘ï¸</button>
        </td>
      `;
    }
    tbody.appendChild(tr);
  });
  updateStats();
  detectConflicts();
}

/* Edit flow */
function startEdit(index){
  // cancel other edits
  clubsData.forEach((c, idx) => { if(idx !== index){ c.editing = false; delete c._backup; } });
  clubsData[index]._backup = {...clubsData[index]}; // shallow backup
  clubsData[index].editing = true;
  renderClubsTable();
}
function saveEdit(index){
  const club = clubsData[index];
  // ensure election2 and paymentEnd computed if needed
  if(club.election1){
    const d = parseDateSafe(club.election1);
    if(d){ 
      // Ø§Ù„Ø§Ù†ØªØ®Ø§Ø¨Ø§Øª Ø§Ù„Ø«Ø§Ù†ÙŠØ© Ø¨Ø¹Ø¯ 14 ÙŠÙˆÙ… Ù…Ù† Ø§Ù„Ø§Ù†ØªØ®Ø§Ø¨Ø§Øª Ø§Ù„Ø£ÙˆÙ„Ù‰
      const newDate = new Date(d.getTime());
      newDate.setDate(newDate.getDate() + 14);
      club.election2 = dateToISO(newDate); 
    }
  }
  if(club.paymentStart){
    const d = parseDateSafe(club.paymentStart);
    if(d){ 
      // Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªØ³Ø¯ÙŠØ¯ Ø¨Ø¹Ø¯ 9 Ø£ÙŠØ§Ù… Ù…Ù† Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªØ³Ø¯ÙŠØ¯ (10 Ø£ÙŠØ§Ù… Ø¨Ù…Ø§ ÙÙŠÙ‡Ø§ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø£ÙˆÙ„)
      const newDate = new Date(d.getTime());
      newDate.setDate(newDate.getDate() + 9);
      club.paymentEnd = dateToISO(newDate); 
    }
  }
  club.editing = false;
  delete club._backup;
  saveClubsToStorage();
  renderClubsTable();
  alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª');
}
function cancelEdit(index){
  if(clubsData[index]._backup){
    clubsData[index] = {...clubsData[index]._backup, editing:false};
    delete clubsData[index]._backup;
  } else {
    clubsData[index].editing = false;
  }
  renderClubsTable();
}

/* Date change handler (live while editing) */
function onDateChange(index, field, value){
  if(!clubsData[index].editing) return;
  clubsData[index][field] = value;
  
  // elections second auto (+14 days) when user sets election1
  if(field === 'election1' && value){
    const d = parseDateSafe(value);
    if(d){ 
      // Ø§Ù„Ø§Ù†ØªØ®Ø§Ø¨Ø§Øª Ø§Ù„Ø«Ø§Ù†ÙŠØ© Ø¨Ø¹Ø¯ 14 ÙŠÙˆÙ… Ù…Ù† Ø§Ù„Ø§Ù†ØªØ®Ø§Ø¨Ø§Øª Ø§Ù„Ø£ÙˆÙ„Ù‰
      const newDate = new Date(d.getTime());
      newDate.setDate(newDate.getDate() + 14);
      clubsData[index].election2 = dateToISO(newDate); 
    }
  }
  // payment end auto (+9 days) when user sets paymentStart
  if(field === 'paymentStart' && value){
    const d = parseDateSafe(value);
    if(d){ 
      // Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªØ³Ø¯ÙŠØ¯ Ø¨Ø¹Ø¯ 9 Ø£ÙŠØ§Ù… Ù…Ù† Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªØ³Ø¯ÙŠØ¯ (10 Ø£ÙŠØ§Ù… Ø¨Ù…Ø§ ÙÙŠÙ‡Ø§ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø£ÙˆÙ„)
      const newDate = new Date(d.getTime());
      newDate.setDate(newDate.getDate() + 9);
      clubsData[index].paymentEnd = dateToISO(newDate); 
    }
  }
  renderClubsTable();
}

/* ================= Ø§Ù„Ø­Ø°Ù Ù„Ù„Ø§Ù†Ø¯ÙŠØ© ================= */
let modalCallback = null;
function confirmDelete(idx){
  showModal('ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù', `Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù†Ø§Ø¯ÙŠ "${escapeHtml(clubsData[idx].name)}"ØŸ`, ()=>{ performDelete(idx); });
}
function performDelete(idx){
  clubsData.splice(idx,1);
  saveClubsToStorage();
  renderClubsTable();
  alert('ØªÙ… Ø§Ù„Ø­Ø°Ù');
}

/* ================= ÙƒØ´Ù Ø§Ù„ØªØ¹Ø§Ø±Ø¶ ================= */
/* returns {days,start:Date,end:Date} inclusive */
function getOverlapRange(s1,e1,s2,e2){
  const a1 = parseDateSafe(s1), b1 = parseDateSafe(e1), a2 = parseDateSafe(s2), b2 = parseDateSafe(e2);
  if(!a1 || !b1 || !a2 || !b2) return {days:0};
  const latestStart = a1 > a2 ? a1 : a2;
  const earliestEnd = b1 < b2 ? b1 : b2;
  if(earliestEnd < latestStart) return {days:0};
  const days = Math.floor((earliestEnd.getTime() - latestStart.getTime())/(1000*60*60*24)) + 1;
  return {days, start: latestStart, end: earliestEnd};
}

function detectConflicts(){
  const conflicts = [];
  for(let i=0;i<clubsData.length;i++){
    for(let j=i+1;j<clubsData.length;j++){
      const A = clubsData[i], B = clubsData[j];
      
      // Ø§Ù„ØªØ³Ø¯ÙŠØ¯ Ù…Ù‚Ø§Ø¨Ù„ Ø§Ù„ØªØ³Ø¯ÙŠØ¯
      if(A.paymentStart && A.paymentEnd && B.paymentStart && B.paymentEnd){
        const ov = getOverlapRange(A.paymentStart,A.paymentEnd,B.paymentStart,B.paymentEnd);
        if(ov.days>0) conflicts.push({type:'ØªØ³Ø¯ÙŠØ¯ Ù…Ø¹ ØªØ³Ø¯ÙŠØ¯', club1:A.name, club2:B.name, start:ov.start, end:ov.end, days:ov.days});
      }
      
      //Ø§Ù„Ø§Ù†ØªØ®Ø§Ø¨Ø§Øª Ù…Ù‚Ø§Ø¨Ù„ Ø§Ù„ØªØ³Ø¯ÙŠØ¯ (Ø§Ù„Ø§Ù†ØªØ®Ø§Ø¨Ø§Øª Ø§Ù„Ø£ÙˆÙ„Ù‰ ÙÙ‚Ø·)
      if(A.election1 && B.paymentStart && B.paymentEnd){
        const ov = getOverlapRange(A.election1,A.election1,B.paymentStart,B.paymentEnd);
        if(ov.days>0) conflicts.push({type:'Ø§Ù†ØªØ®Ø§Ø¨Ø§Øª Ù…Ø¹ ØªØ³Ø¯ÙŠØ¯', club1:A.name, club2:B.name, start:ov.start, end:ov.end, days:ov.days});
      }
      if(B.election1 && A.paymentStart && A.paymentEnd){
        const ov = getOverlapRange(B.election1,B.election1,A.paymentStart,A.paymentEnd);
        if(ov.days>0) conflicts.push({type:'Ø§Ù†ØªØ®Ø§Ø¨Ø§Øª Ù…Ø¹ ØªØ³Ø¯ÙŠØ¯', club1:B.name, club2:A.name, start:ov.start, end:ov.end, days:ov.days});
      }
      
      // Ø§Ù„Ø§Ù†ØªØ®Ø§Ø¨Ø§Øª Ù…Ù‚Ø§Ø¨Ù„ Ø§Ù„Ø§Ù†ØªØ®Ø§Ø¨Ø§Øª (Ø§Ù„Ø§Ù†ØªØ®Ø§Ø¨Ø§Øª Ø§Ù„Ø£ÙˆÙ„Ù‰ ÙÙ‚Ø·)
      if(A.election1 && B.election1){
        const ov = getOverlapRange(A.election1,A.election1,B.election1,B.election1);
        if(ov.days>0) conflicts.push({type:'Ø§Ù†ØªØ®Ø§Ø¨Ø§Øª Ù…Ø¹ Ø§Ù†ØªØ®Ø§Ø¨Ø§Øª', club1:A.name, club2:B.name, start:ov.start, end:ov.end, days:ov.days});
      }
    }
  }
  renderConflicts(conflicts);
}

function renderConflicts(conflicts){
  const container = document.getElementById('conflictsContainer'); container.innerHTML = '';
  if(!conflicts || conflicts.length === 0){ container.innerHTML = '<div style="padding:12px">âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¹Ø§Ø±Ø¶Ø§Øª</div>'; return; }
  const table = document.createElement('table'); table.className = 'conflicts-table';
  let html = `<thead><tr><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ø£Ù†Ø¯ÙŠØ©</th><th>Ù†Ø·Ø§Ù‚ Ø§Ù„ØªØ¯Ø§Ø®Ù„</th><th>Ø§Ù„Ø£ÙŠØ§Ù…</th></tr></thead><tbody>`;
  let total = 0;
  conflicts.forEach(c=>{
    const s = formatDateDisplay(c.start), e = formatDateDisplay(c.end);
    const range = (s === e) ? s : `${s} - ${e}`;
    html += `<tr>
      <td class="conflict-type">${escapeHtml(c.type)}</td>
      <td>${escapeHtml(c.club1)} âš”ï¸ ${escapeHtml(c.club2)}</td>
      <td>${escapeHtml(range)}</td>
      <td class="conflict-days">${c.days} ÙŠÙˆÙ…</td>
    </tr>`;
    total += c.days;
  });
  html += `<tr style="background:#f8faf8;font-weight:700"><td colspan="3">Ù…Ø¬Ù…ÙˆØ¹ Ø£ÙŠØ§Ù… Ø§Ù„ØªØ¹Ø§Ø±Ø¶Ø§Øª</td><td>${total} ÙŠÙˆÙ…</td></tr>`;
  html += `</tbody>`;
  table.innerHTML = html;
  container.appendChild(table);
}

/* ================= Ø§Ù„ØªØµØ¯ÙŠØ± / Ø§Ø³ØªÙŠØ±Ø§Ø¯ / Ù…Ø³Ø­ ================= */
function exportBackup(){
  const payload = { 
    version:'2.0', 
    exportDate: new Date().toISOString(), 
    clubs: clubsData.map(c=>{ const {editing,_backup,...rest}=c; return rest; }), 
    dropdownOptions: getDropdownOptions(),
    clubsReconciliation: clubsReconciliation,
    presidents: presidentsData
  };
  const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json;charset=utf-8'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = `backup-clubs-${new Date().toISOString().split('T')[0]}.json`; a.click();
  localStorage.setItem('lastBackup', new Date().toISOString()); updateLastBackupDisplay();
  alert('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©');
}

function triggerImportBackup(){
  const input = document.createElement('input'); input.type='file'; input.accept='.json';
  input.onchange = ()=> {
    const file = input.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      try {
        const parsed = JSON.parse(e.target.result);
        if(Array.isArray(parsed)){
          if(!confirm('Ø§Ù„Ù…Ù„Ù ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…ØµÙÙˆÙØ© Ø£Ù†Ø¯ÙŠØ© Ù…Ø¨Ø§Ø´Ø±Ø©. Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©ØŸ')) return;
          clubsData = parsed.map(normalizeClub);
        } else if(parsed && parsed.clubs){
          if(!confirm('Ø§Ù„Ù…Ù„Ù ÙŠØ¨Ø¯Ùˆ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©. Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©ØŸ')) return;
          clubsData = parsed.clubs.map(normalizeClub);
          if(parsed.dropdownOptions && Array.isArray(parsed.dropdownOptions)){
            const select = document.getElementById('clubSelect');
            while(select.options.length>1) select.remove(1);
            parsed.dropdownOptions.forEach(name => { const opt=document.createElement('option'); opt.value=name; opt.text=name; select.add(opt); });
            saveDropdownOptions(parsed.dropdownOptions);
          }
          if(parsed.clubsReconciliation){
            clubsReconciliation = parsed.clubsReconciliation;
            saveReconciliationDates();
          }
          if(parsed.presidents && Array.isArray(parsed.presidents)){
            presidentsData = parsed.presidents;
            savePresidentsToStorage();
          }
        } else {
          alert('ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ù‡ JSON Ø¨ØµÙŠØºØ© ØµØ­ÙŠØ­Ø©.');
          return;
        }
        saveClubsToStorage(); 
        renderClubsTable(); 
        renderReconciliationTable();
        renderPresidentsTable();
        updatePresidentsStats();
        alert('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
      } catch(err){
        alert('Ø®Ø·Ø£ Ø¹Ù†Ø¯ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù: ' + err.message);
      }
    };
    reader.readAsText(file);
  };
  input.click();
}

function clearAllData(){
  if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ\n\nØ³ÙŠØªÙ… Ù…Ø³Ø­:\n- Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ø£Ù†Ø¯ÙŠØ©\n- ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„ØªÙˆÙÙŠÙ‚\n- Ø±Ø¤Ø³Ø§Ø¡ Ø§Ù„Ø£Ù†Ø¯ÙŠØ©')) return;
  clubsData = []; 
  clubsReconciliation = {};
  presidentsData = [];
  localStorage.removeItem('clubs'); 
  localStorage.removeItem('clubsReconciliation');
  localStorage.removeItem('presidents');
  localStorage.removeItem('dropdownOptions'); 
  ensureDropdownOptions();
  saveClubsToStorage(); 
  renderClubsTable(); 
  renderReconciliationTable();
  renderPresidentsTable();
  updatePresidentsStats();
  updateLastBackupDisplay(); 
  alert('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
}

/* Simple CSV exporter (Excel ) */
function exportCSV(){
  const rows = [['Ø§Ø³Ù… Ø§Ù„Ù†Ø§Ø¯ÙŠ','Ø§Ù„Ø§Ù†ØªØ®Ø§Ø¨Ø§Øª 1','Ø§Ù„Ø§Ù†ØªØ®Ø§Ø¨Ø§Øª 2','Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªØ³Ø¯ÙŠØ¯','Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªØ³Ø¯ÙŠØ¯']];
  clubsData.forEach(c => rows.push([c.name || '', c.election1 || '', c.election2 || '', c.paymentStart || '', c.paymentEnd || '']));
  const csv = rows.map(r => r.map(cell => `"${(cell+'').replace(/"/g,'""')}"`).join(',')).join('\r\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `clubs-${new Date().toISOString().split('T')[0]}.csv`; a.click();
}

/* ================= Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ================= */
function normalizeClub(obj){
  return {
    id: obj.id || Date.now() + Math.floor(Math.random()*10000),
    name: (obj.name || obj.title || obj.club || '').toString(),
    election1: obj.election1 || '',
    election2: obj.election2 || '',
    paymentStart: obj.paymentStart || '',
    paymentEnd: obj.paymentEnd || '',
    editing: false
  };
}

function parseDateSafe(s){
  if(!s) return null;
  // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ ØªÙ†Ø³ÙŠÙ‚ YYYY-MM-DD Ù…Ø¨Ø§Ø´Ø±Ø©
  if(typeof s === 'string' && s.match(/^\d{4}-\d{2}-\d{2}$/)) {
    const parts = s.split('-');
    const year = parseInt(parts[0]);
    const month = parseInt(parts[1]) - 1; // Ø§Ù„Ø£Ø´Ù‡Ø± Ù…Ù† 0-11
    const day = parseInt(parts[2]);
    return new Date(year, month, day);
  }
  if(s instanceof Date) return new Date(s.getFullYear(), s.getMonth(), s.getDate());
  const d = new Date(s); 
  return isNaN(d.getTime()) ? null : new Date(d.getFullYear(), d.getMonth(), d.getDate());
}
function dateToISO(d){ 
  if(!d) return '';
  const year = d.getFullYear();
  const month = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}
function formatDateDisplay(d){
  const dt = (d instanceof Date) ? d : parseDateSafe(d);
  if(!dt) return '';
  return `${String(dt.getDate()).padStart(2,'0')}/${String(dt.getMonth()+1).padStart(2,'0')}/${dt.getFullYear()}`;
}
function escapeHtml(s){ if(s===undefined || s===null) return ''; return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }

/* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… */
function updateStats(){ document.getElementById('clubsCount').textContent = `${clubsData.length} Ù†Ø§Ø¯ÙŠ`; }
function updateLastBackupDisplay(){ const s = localStorage.getItem('lastBackup'); document.getElementById('lastBackup').textContent = s ? (new Date(s)).toLocaleString() : 'Ù„Ø§ ØªÙˆØ¬Ø¯'; }


function showModal(title, message, onConfirm){
  modalCallback = onConfirm;
  const modal = document.getElementById('confirmModal'); const box = modal.querySelector('.box');
  const prev = box.querySelector('#confirmText'); if(prev) prev.remove();
  const txt = document.createElement('div'); txt.id='confirmText'; txt.innerHTML = `<strong>${escapeHtml(title)}</strong><p style="margin-top:8px">${escapeHtml(message)}</p>`;
  box.insertBefore(txt, box.querySelector('.actions'));
  modal.style.display = 'flex';
}
function closeModal(confirmed){
  const modal = document.getElementById('confirmModal'); modal.style.display = 'none';
  if(confirmed && typeof modalCallback === 'function') modalCallback();
  modalCallback = null;
}

/* ================= Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ø§Ù†ØªØ®Ø§Ø¨ÙŠØ© ================= */

// ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø¤Ø³Ø§Ø¡ Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ†
function loadPresidentsFromStorage(){
  const s = localStorage.getItem('presidents');
  if(s){
    try{ presidentsData = JSON.parse(s); } catch(e){ presidentsData = []; }
  } else presidentsData = [];
}

// Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø¤Ø³Ø§Ø¡
function savePresidentsToStorage(){
  try{ localStorage.setItem('presidents', JSON.stringify(presidentsData)); } catch(e){}
  updatePresidentsStats();
}

// Ù…Ù„Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù†Ø¯ÙŠØ© ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø±Ø¤Ø³Ø§Ø¡
function populatePresidentClubSelect(){
  const select = document.getElementById('presidentClubSelect');
  while(select.options.length > 1) select.remove(1);
  const clubs = getDropdownOptions();
  clubs.forEach(name => {
    const opt = document.createElement('option'); 
    opt.value = name; 
    opt.text = name; 
    select.add(opt);
  });
}

/* ================= ÙˆØ¸Ø§Ø¦Ù ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„ØªÙˆÙÙŠÙ‚ ================= */

// ØªØ­Ù…ÙŠÙ„ ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„ØªÙˆÙÙŠÙ‚ Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ†
function loadReconciliationDates(){
  try{
    const saved = localStorage.getItem('clubsReconciliation');
    if(saved) clubsReconciliation = JSON.parse(saved);
  }catch(e){}
}

// Ø­ÙØ¸ ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„ØªÙˆÙÙŠÙ‚
function saveReconciliationDates(){
  try{
    localStorage.setItem('clubsReconciliation', JSON.stringify(clubsReconciliation));
  }catch(e){}
}

// Ù…Ù„Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù†Ø¯ÙŠØ© ÙÙŠ Ù‚Ø³Ù… Ø§Ù„ØªÙˆÙÙŠÙ‚
function populateReconciliationClubSelect(){
  const select = document.getElementById('clubSelectReconciliation');
  while(select.options.length > 1) select.remove(1);
  
  const clubs = getDropdownOptions();
  clubs.forEach(name => {
    const opt = document.createElement('option'); 
    opt.value = name; 
    opt.text = name; 
    select.add(opt);
  });
}

// Ø­ÙØ¸ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙˆÙÙŠÙ‚ Ù„Ù†Ø§Ø¯ÙŠ
function setReconciliationDate(){
  const clubSelect = document.getElementById('clubSelectReconciliation');
  const dateInput = document.getElementById('reconciliationDateInput');
  
  const clubName = clubSelect.value;
  const dateValue = dateInput.value.trim();
  
  if(!clubName){ alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù†Ø§Ø¯ÙŠ'); return; }
  if(!dateValue){ alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙˆÙÙŠÙ‚'); return; }
  if(!isValidDate(dateValue)){ alert('ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ­ÙŠØ­. Ø§Ù„ØµÙŠØºØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: ÙŠÙˆÙ…/Ø´Ù‡Ø±/Ø³Ù†Ø© (Ù…Ø«Ø§Ù„: 09/07/2009)'); return; }
  
  clubsReconciliation[clubName] = dateValue;
  saveReconciliationDates();
  renderReconciliationTable();
  
  // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø£Ù‡Ù„ÙŠØ© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø¤Ø³Ø§Ø¡
  presidentsData.forEach(p => calculatePresidentEligibility(p));
  savePresidentsToStorage();
  renderPresidentsTable();
  
  dateInput.value = '';
  clubSelect.value = '';
  alert('ØªÙ… Ø­ÙØ¸ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙˆÙÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­');
}

// Ø­Ø°Ù ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙˆÙÙŠÙ‚
function deleteReconciliationDate(clubName){
  if(!confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙˆÙÙŠÙ‚ Ù„Ù€ ${clubName}ØŸ`)) return;
  
  delete clubsReconciliation[clubName];
  saveReconciliationDates();
  renderReconciliationTable();
  
  // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø£Ù‡Ù„ÙŠØ© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø¤Ø³Ø§Ø¡
  presidentsData.forEach(p => calculatePresidentEligibility(p));
  savePresidentsToStorage();
  renderPresidentsTable();
  
  alert('ØªÙ… Ø­Ø°Ù ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙˆÙÙŠÙ‚');
}

// Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„ØªÙˆÙÙŠÙ‚
function renderReconciliationTable(){
  const tbody = document.querySelector('#reconciliationDatesTable tbody');
  tbody.innerHTML = '';
  
  const clubs = Object.keys(clubsReconciliation).sort();
  
  if(clubs.length === 0){
    tbody.innerHTML = '<tr><td colspan="3" class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙˆØ§Ø±ÙŠØ® ØªÙˆÙÙŠÙ‚ Ù…Ø­ÙÙˆØ¸Ø©</td></tr>';
    return;
  }
  
  clubs.forEach(clubName => {
    const date = clubsReconciliation[clubName];
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${clubName}</td>
      <td><strong>${date}</strong></td>
      <td class="actions">
        <button class="delete" onclick="deleteReconciliationDate('${clubName}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

/* ================= ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„ØªÙˆØ§Ø±ÙŠØ® ================= */

// ØªØ­ÙˆÙŠÙ„ Ù†Øµ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¥Ù„Ù‰ ÙƒØ§Ø¦Ù† Date
function parseDate(dateString){
  const parts = dateString.split('/');
  const day = parseInt(parts[0]);
  const month = parseInt(parts[1]) - 1;
  const year = parseInt(parts[2]);
  return new Date(year, month, day);
}

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®
function isValidDate(dateString){
  const regex = /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/;
  if(!regex.test(dateString)) return false;
  
  try{
    const date = parseDate(dateString);
    return date instanceof Date && !isNaN(date);
  }catch(e){
    return false;
  }
}

// Ù…Ù‚Ø§Ø±Ù†Ø© ØªØ§Ø±ÙŠØ®ÙŠÙ†
function compareDates(date1String, date2String){
  const d1 = parseDate(date1String);
  const d2 = parseDate(date2String);
  
  if(d1 < d2) return -1;
  if(d1 > d2) return 1;
  return 0;
}

// Ø­Ø³Ø§Ø¨ Ø§Ù„ÙØ±Ù‚ Ø¨Ø§Ù„Ø£ÙŠØ§Ù… Ø¨ÙŠÙ† ØªØ§Ø±ÙŠØ®ÙŠÙ†
function getDaysDifference(startDateString, endDateString){
  const start = parseDate(startDateString);
  const end = parseDate(endDateString);
  
  const diffTime = end - start;
  const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
  
  return diffDays;
}

// Ø­Ø³Ø§Ø¨ Ø§Ù„ÙØ±Ù‚ Ø¨Ø§Ù„Ø³Ù†ÙˆØ§Øª
function getYearsDifference(startDateString, endDateString){
  const start = parseDate(startDateString);
  const end = parseDate(endDateString);
  
  let years = end.getFullYear() - start.getFullYear();
  const monthDiff = end.getMonth() - start.getMonth();
  const dayDiff = end.getDate() - start.getDate();
  
  if(monthDiff < 0 || (monthDiff === 0 && dayDiff < 0)){
    years--;
  }
  
  return years;
}

// ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ®
function formatDate(date){
  const day = String(date.getDate()).padStart(2, '0');
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const year = date.getFullYear();
  return `${day}/${month}/${year}`;
}

// Ø¥Ø¶Ø§ÙØ© Ø³Ù†ÙˆØ§Øª Ù„ØªØ§Ø±ÙŠØ®
function addYearsToDate(dateString, years){
  const date = parseDate(dateString);
  date.setFullYear(date.getFullYear() + years);
  return formatDate(date);
}

/* ================= ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø±Ø¤Ø³Ø§Ø¡ ================= */

// Ø¥Ø¶Ø§ÙØ© Ø±Ø¦ÙŠØ³ Ø¬Ø¯ÙŠØ¯
function addNewPresident(){
  const nameInput = document.getElementById('presidentName');
  const clubSelect = document.getElementById('presidentClubSelect');
  const dateInput = document.getElementById('cycleStartDate');
  
  const name = nameInput.value.trim();
  const clubName = clubSelect.value;
  const startDate = dateInput.value.trim();
  
  if(!name){ alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø±Ø¦ÙŠØ³'); return; }
  if(!clubName){ alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù†Ø§Ø¯ÙŠ'); return; }
  if(!startDate){ alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¯ÙˆØ±Ø©'); return; }
  if(!isValidDate(startDate)){ alert('ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ­ÙŠØ­. Ø§Ù„ØµÙŠØºØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: ÙŠÙˆÙ…/Ø´Ù‡Ø±/Ø³Ù†Ø© (Ù…Ø«Ø§Ù„: 15/03/2022)'); return; }
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø±Ø¦ÙŠØ³ Ø¨Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù†Ø§Ø¯ÙŠ
  if(presidentsData.some(p => p.name === name && p.clubName === clubName)){
    alert('ÙŠÙˆØ¬Ø¯ Ø±Ø¦ÙŠØ³ Ø¨Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù†Ø§Ø¯ÙŠ Ø¨Ø§Ù„ÙØ¹Ù„');
    return;
  }
  
  const endDate = addYearsToDate(startDate, 3);
  
  const president = {
    id: Date.now() + Math.random(),
    name: name,
    clubName: clubName,
    cycles: [{
      cycleNumber: 1,
      startDate: startDate,
      endDate: endDate,
      status: 'current',
      countable: true
    }],
    totalCycles: 1,
    countableCycles: 1,
    consecutiveCycles: 1,
    canNominate: true,
    nextEligibleDate: null
  };
  
  calculatePresidentEligibility(president);
  presidentsData.push(president);
  savePresidentsToStorage();
  renderPresidentsTable();
  updatePresidentsStats();
  
  nameInput.value = '';
  clubSelect.value = '';
  dateInput.value = '';
  alert('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø¦ÙŠØ³ Ø¨Ù†Ø¬Ø§Ø­');
}

// Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ù…ØªØªØ§Ù„ÙŠØ© Ø§Ù„Ù…Ø­Ø³ÙˆØ¨Ø©
function calculateConsecutiveCycles(cycles){
  if(cycles.length === 0) return 0;
  
  // ÙÙ„ØªØ±Ø© Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ù…Ø­Ø³ÙˆØ¨Ø© ÙÙ‚Ø·
  const countableCycles = cycles.filter(c => c.countable);
  if(countableCycles.length === 0) return 0;
  
  // Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ù…Ø­Ø³ÙˆØ¨Ø© ØªÙØ¹ØªØ¨Ø± Ù…ØªØªØ§Ù„ÙŠØ©
  // Ù„Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠÙØ¯Ø®Ù„Ù‡Ø§ Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø²Ù…Ù†ÙŠ
  return countableCycles.length;
}

// ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ù…Ø­Ø³ÙˆØ¨Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙˆÙÙŠÙ‚
function markCountableCycles(president){
  const reconciliationDate = clubsReconciliation[president.clubName];
  
  if(!reconciliationDate){
    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ ØªØ§Ø±ÙŠØ® ØªÙˆÙÙŠÙ‚ØŒ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ù…Ø­Ø³ÙˆØ¨Ø©
    president.cycles.forEach(cycle => {
      cycle.countable = true;
    });
    return;
  }
  
  president.cycles.forEach(cycle => {
    // Ø§Ù„Ø¯ÙˆØ±Ø© Ù…Ø­Ø³ÙˆØ¨Ø© Ø¥Ø°Ø§ Ø¨Ø¯Ø£Øª ÙÙŠ Ø£Ùˆ Ø¨Ø¹Ø¯ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙˆÙÙŠÙ‚
    cycle.countable = compareDates(cycle.startDate, reconciliationDate) >= 0;
  });
}

// Ø­Ø³Ø§Ø¨ Ø£Ù‡Ù„ÙŠØ© Ø§Ù„ØªØ±Ø´Ø­
function calculatePresidentEligibility(president){
  // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ù…Ø­Ø³ÙˆØ¨Ø©
  markCountableCycles(president);
  
  // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
  president.totalCycles = president.cycles.length;
  president.countableCycles = president.cycles.filter(c => c.countable).length;
  president.consecutiveCycles = calculateConsecutiveCycles(president.cycles);
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ (3 Ø¯ÙˆØ±Ø§Øª Ù…Ø­Ø³ÙˆØ¨Ø©)
  if(president.countableCycles >= 3){
    president.canNominate = false;
    president.nextEligibleDate = null;
    return;
  }
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¯ÙˆØ±ØªÙŠÙ† Ø§Ù„Ù…ØªØªØ§Ù„ÙŠØªÙŠÙ†
  if(president.consecutiveCycles >= 2){
    const lastCycle = president.cycles[president.cycles.length - 1];
    president.canNominate = false;
    president.nextEligibleDate = addYearsToDate(lastCycle.endDate, 3);
    return;
  }
  
  president.canNominate = true;
  president.nextEligibleDate = null;
}

// Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©
function addCycleToPresident(index){
  const president = presidentsData[index];
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ù‡Ù„ÙŠØ©
  if(!president.canNominate){
    if(president.countableCycles >= 3){
      alert('â›” Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©\n\nØ§Ù„Ø³Ø¨Ø¨: ÙˆØµÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ (3 Ø¯ÙˆØ±Ø§Øª Ù…Ø­Ø³ÙˆØ¨Ø©)');
      return;
    }
    if(president.consecutiveCycles >= 2){
      alert(`â›” Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©\n\nØ§Ù„Ø³Ø¨Ø¨: Ø£ÙƒÙ…Ù„ Ø¯ÙˆØ±ØªÙŠÙ† Ù…ØªØªØ§Ù„ÙŠØªÙŠÙ†\nÙŠØ¬Ø¨ Ø§Ù„Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø¯ÙˆØ±Ø© ÙˆØ§Ø­Ø¯Ø© (3 Ø³Ù†ÙˆØ§Øª)\nÙŠØ­Ù‚ Ù„Ù‡ Ø§Ù„ØªØ±Ø´Ø­ ÙÙŠ ØªØ§Ø±ÙŠØ®: ${president.nextEligibleDate}`);
      return;
    }
  }
  
  const lastCycle = president.cycles[president.cycles.length - 1];
  const startDate = prompt(`Ø£Ø¯Ø®Ù„ ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (ÙŠÙˆÙ…/Ø´Ù‡Ø±/Ø³Ù†Ø©):\n\n(Ø¢Ø®Ø± Ø¯ÙˆØ±Ø© Ø§Ù†ØªÙ‡Øª ÙÙŠ ${lastCycle.endDate})`, lastCycle.endDate);
  
  if(!startDate) return;
  
  if(!isValidDate(startDate)){
    alert('ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ­ÙŠØ­. Ø§Ù„ØµÙŠØºØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: ÙŠÙˆÙ…/Ø´Ù‡Ø±/Ø³Ù†Ø© (Ù…Ø«Ø§Ù„: 15/03/2025)');
    return;
  }
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„ØªØ§Ø±ÙŠØ® Ù„ÙŠØ³ ÙÙŠ Ø§Ù„Ù…Ø§Ø¶ÙŠ Ø§Ù„Ø¨Ø¹ÙŠØ¯
  // Ù†Ø³Ù…Ø­ Ø¨Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ±Ø© Ù‚Ø¨Ù„ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ø¨Ø­Ø¯ Ø£Ù‚ØµÙ‰ 30 ÙŠÙˆÙ…Ø§Ù‹
  const daysDiff = getDaysDifference(startDate, lastCycle.endDate);
  
  if(daysDiff < -30){
    alert(`â›” Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ±Ø© ÙÙŠ Ø§Ù„Ù…Ø§Ø¶ÙŠ\n\nØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ†:\n- ÙÙŠ Ù†ÙØ³ ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© (${lastCycle.endDate})\n- Ø£Ùˆ Ù‚Ø¨Ù„Ù‡ Ø¨Ø­Ø¯ Ø£Ù‚ØµÙ‰ 30 ÙŠÙˆÙ…Ø§Ù‹\n\nÙ…Ù„Ø§Ø­Ø¸Ø©: ÙŠÙØ³Ù…Ø­ Ø¨Ø¨Ø¯Ø¡ Ø§Ù„Ø¯ÙˆØ±Ø© Ù‚Ø¨Ù„ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ø¨Ù€ 15-25 ÙŠÙˆÙ… Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ®Ø§Ø¨Ø§Øª`);
    return;
  }
  
  // Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ù…Ø¶Ø§ÙØ© ØªÙØ¹ØªØ¨Ø± Ù…ØªØªØ§Ù„ÙŠØ©
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ØªØ¬Ø§ÙˆØ² Ø¯ÙˆØ±ØªÙŠÙ† Ù…ØªØªØ§Ù„ÙŠØªÙŠÙ†
  if(president.consecutiveCycles >= 2){
    alert('â›” Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ±Ø© Ø«Ø§Ù„Ø«Ø© Ù…ØªØªØ§Ù„ÙŠØ©\n\nÙŠØ¬Ø¨ Ø§Ù„Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø¯ÙˆØ±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ (Ø¹Ø¯Ù… Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©)');
    return;
  }
  
  const endDate = addYearsToDate(startDate, 3);
  
  const newCycle = {
    cycleNumber: president.cycles.length + 1,
    startDate: startDate,
    endDate: endDate,
    status: 'current',
    countable: true
  };
  
  // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
  lastCycle.status = 'completed';
  
  president.cycles.push(newCycle);
  calculatePresidentEligibility(president);
  savePresidentsToStorage();
  renderPresidentsTable();
  updatePresidentsStats();
  alert('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­');
}

// Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³
function showPresidentCycles(index){
  const president = presidentsData[index];
  const modal = document.getElementById('cyclesModal');
  const title = document.getElementById('cyclesModalTitle');
  const content = document.getElementById('cyclesModalContent');
  
  title.textContent = `ØªÙØ§ØµÙŠÙ„ Ø¯ÙˆØ±Ø§Øª: ${president.name} - ${president.clubName}`;
  
  const reconciliationDate = clubsReconciliation[president.clubName];
  
  let html = '<div style="margin-bottom:12px">';
  html += `<div style="display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap">`;
  html += `<span class="badge">Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${president.totalCycles} Ø¯ÙˆØ±Ø§Øª</span>`;
  html += `<span class="badge">Ù…Ø­Ø³ÙˆØ¨Ø©: ${president.countableCycles} Ø¯ÙˆØ±Ø§Øª</span>`;
  html += `<span class="badge">Ù…ØªØªØ§Ù„ÙŠØ©: ${president.consecutiveCycles}</span>`;
  html += `</div>`;
  if(reconciliationDate){
    html += `<div style="font-size:13px;color:var(--muted)">ğŸ“… ØªØ§Ø±ÙŠØ® ØªÙˆÙÙŠÙ‚ Ø§Ù„Ù†Ø¸Ø§Ù…: <strong>${reconciliationDate}</strong></div>`;
  }
  html += '</div>';
  
  html += '<table style="width:100%;min-width:auto">';
  html += '<thead><tr><th>Ø§Ù„Ø¯ÙˆØ±Ø©</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©</th><th>Ø§Ù„Ù…Ø¯Ø©</th><th>Ù…Ø­Ø³ÙˆØ¨Ø©ØŸ</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead>';
  html += '<tbody>';
  
  president.cycles.forEach((cycle, i) => {
    const duration = getYearsDifference(cycle.startDate, cycle.endDate);
    const statusText = cycle.status === 'current' ? 'ğŸŸ¢ Ø­Ø§Ù„ÙŠØ©' : 'âœ… Ù…ÙƒØªÙ…Ù„Ø©';
    const countableText = cycle.countable ? 'âœ… Ù†Ø¹Ù…' : 'âŒ Ù„Ø§';
    
    // Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ù…Ø­Ø³ÙˆØ¨Ø© ØªÙØ¹ØªØ¨Ø± Ù…ØªØªØ§Ù„ÙŠØ©
    const isConsecutive = (i > 0 && cycle.countable && president.cycles[i-1].countable);
    const consecutiveIcon = isConsecutive ? ' ğŸ”—' : '';
    
    html += `<tr>`;
    html += `<td>${cycle.cycleNumber}${consecutiveIcon}</td>`;
    html += `<td>${cycle.startDate}</td>`;
    html += `<td>${cycle.endDate}</td>`;
    html += `<td>${duration} Ø³Ù†ÙˆØ§Øª</td>`;
    html += `<td>${countableText}</td>`;
    html += `<td>${statusText}</td>`;
    html += `</tr>`;
  });
  
  html += '</tbody></table>';
  
  // Ø¥Ø¶Ø§ÙØ© Ù…Ø®Ø·Ø· Ø²Ù…Ù†ÙŠ Ø¨ØµØ±ÙŠ
  html += '<div style="margin-top:16px;padding:12px;background:#f9fafb;border-radius:8px">';
  html += '<div style="font-weight:700;margin-bottom:8px">Ø§Ù„Ù…Ø®Ø·Ø· Ø§Ù„Ø²Ù…Ù†ÙŠ:</div>';
  html += '<div style="display:flex;gap:4px;flex-wrap:wrap">';
  
  president.cycles.forEach((cycle, i) => {
    // Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ù…Ø­Ø³ÙˆØ¨Ø© ØªÙØ¹ØªØ¨Ø± Ù…ØªØªØ§Ù„ÙŠØ©
    // Ø§Ù„Ø§Ù†Ù‚Ø·Ø§Ø¹ ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø¨ÙŠÙ† Ø¯ÙˆØ±Ø© Ù…Ø­Ø³ÙˆØ¨Ø© ÙˆØ¯ÙˆØ±Ø© ØºÙŠØ± Ù…Ø­Ø³ÙˆØ¨Ø©
    const isConsecutive = (i > 0 && cycle.countable && president.cycles[i-1].countable);
    
    const color = cycle.countable ? (cycle.status === 'current' ? '#10b981' : '#3b82f6') : '#9ca3af';
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù†Ù‚Ø·Ø§Ø¹ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù…Ø­Ø³ÙˆØ¨Ø© ÙˆØ§Ù„Ø³Ø§Ø¨Ù‚Ø© ØºÙŠØ± Ù…Ø­Ø³ÙˆØ¨Ø©
    if(i > 0 && cycle.countable && !president.cycles[i-1].countable){
      html += `<div style="padding:8px;background:#ef4444;color:#fff;border-radius:4px;font-size:12px">âŒ Ø§Ù†Ù‚Ø·Ø§Ø¹</div>`;
    }
    
    html += `<div style="padding:8px;background:${color};color:#fff;border-radius:4px;font-size:12px">`;
    html += `Ø¯ÙˆØ±Ø© ${cycle.cycleNumber}${cycle.countable ? '' : ' (ØºÙŠØ± Ù…Ø­Ø³ÙˆØ¨Ø©)'}<br>${cycle.startDate}<br>Ø¥Ù„Ù‰<br>${cycle.endDate}`;
    html += `</div>`;
  });
  
  html += '</div></div>';
  
  content.innerHTML = html;
  modal.style.display = 'flex';
}

function closeCyclesModal(){
  document.getElementById('cyclesModal').style.display = 'none';
}

// Ø­Ø°Ù Ø±Ø¦ÙŠØ³
function deletePresident(index){
  const president = presidentsData[index];
  showModal('ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù', `Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø±Ø¦ÙŠØ³ "${president.name}" Ù…Ù† Ù†Ø§Ø¯ÙŠ "${president.clubName}"ØŸ`, ()=>{
    presidentsData.splice(index, 1);
    savePresidentsToStorage();
    renderPresidentsTable();
    alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø±Ø¦ÙŠØ³');
  });
}

// Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±Ø¤Ø³Ø§Ø¡
function renderPresidentsTable(){
  const tbody = document.querySelector('#presidentsTable tbody');
  tbody.innerHTML = '';
  
  if(presidentsData.length === 0){
    tbody.innerHTML = '<tr><td colspan="8" style="padding:20px;color:var(--muted)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª. Ø£Ø¶Ù Ø±Ø¦ÙŠØ³ Ù†Ø§Ø¯ÙŠ Ø¬Ø¯ÙŠØ¯</td></tr>';
    return;
  }
  
  presidentsData.forEach((president, i) => {
    const tr = document.createElement('tr');
    
    const eligibilityText = president.canNominate ? 'âœ… ÙŠØ­Ù‚ Ù„Ù‡' : 'â›” Ù„Ø§ ÙŠØ­Ù‚ Ù„Ù‡';
    const eligibilityColor = president.canNominate ? '#16a34a' : '#ef4444';
    
    const nextDateText = president.nextEligibleDate ? president.nextEligibleDate : '-';
    
    tr.innerHTML = `
      <td>${escapeHtml(president.name)}</td>
      <td>${escapeHtml(president.clubName)}</td>
      <td><span class="badge">${president.totalCycles}</span></td>
      <td><span class="badge">${president.countableCycles}</span></td>
      <td><span class="badge">${president.consecutiveCycles}</span></td>
      <td style="color:${eligibilityColor};font-weight:700">${eligibilityText}</td>
      <td>${nextDateText}</td>
      <td class="actions">
        <button class="edit" onclick="addCycleToPresident(${i})" title="Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ±Ø©">â•</button>
        <button class="save" onclick="showPresidentCycles(${i})" title="Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„">ğŸ“‹</button>
        <button class="delete" onclick="deletePresident(${i})" title="Ø­Ø°Ù">ğŸ—‘ï¸</button>
      </td>
    `;
    
    tbody.appendChild(tr);
  });
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
function updatePresidentsStats(){
  const total = presidentsData.length;
  const eligible = presidentsData.filter(p => p.canNominate).length;
  const ineligible = total - eligible;
  
  document.getElementById('presidentsCount').textContent = `${total} Ø±Ø¦ÙŠØ³`;
  document.getElementById('eligibleCount').textContent = `${eligible} Ù…Ø¤Ù‡Ù„`;
  document.getElementById('ineligibleCount').textContent = `${ineligible} Ù…Ù…Ù†ÙˆØ¹`;
}

/*  Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ùˆ ÙˆØ­Ø¯Ø© Ø§Ù„ØªØ­ÙƒÙ… */
window._save = saveClubsToStorage;
window._load = loadClubsFromStorage;
window._savePresidents = savePresidentsToStorage;
window._loadPresidents = loadPresidentsFromStorage;

</script>
</body>
</html>



