<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ØªØ·Ø¨ÙŠÙ‚ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù†ØªØ®Ø§Ø¨Ø§Øª Ø§Ù„Ø£Ù†Ø¯ÙŠØ© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ©</title>
  <style>
    :root{
      --bg:#f4f6fb; --card:#fff; --primary1:#2563eb; --primary2:#7c3aed;
      --muted:#6b7280; --danger:#ef4444; --success:#16a34a; --shadow:0 8px 24px rgba(0,0,0,0.08);
      --radius:12px;
    }
    *{box-sizing:border-box}
    body{
      font-family: "Cairo", "Tahoma", Arial, sans-serif;
      direction: rtl;
      margin:0;
      background:var(--bg);
      color:#111827;
      -webkit-font-smoothing:antialiased;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    header{
      background: linear-gradient(135deg,var(--primary1),var(--primary2));
      color:#fff;
      padding:18px 12px;
      box-shadow:var(--shadow);
    }
    header .container{
      max-width:1200px;
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    header h1{margin:0;font-size:18px;font-weight:700}
    nav{max-width:1200px;margin:12px auto 0;display:flex;gap:0;padding:0 12px}
    .tab{
      flex:1;padding:12px;border:none;background:#fff;border-radius:10px 10px 0 0;cursor:pointer;font-weight:600;color:#374151;
      border-bottom:3px solid transparent;transition:all .18s;
    }
    .tab.active{color:var(--primary1);border-bottom-color:var(--primary1);background:#fff}
    main{
      max-width:1200px;
      margin:16px auto;
      padding:0 12px;
      flex:1;
      width:100%;
    }
    .panel{background:var(--card);padding:16px;border-radius:var(--radius);box-shadow:var(--shadow);margin-bottom:16px}
    .controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .controls select, .controls input[type="text"]{
      padding:10px;border-radius:10px;border:1px solid #e6eefc;min-width:220px;background:#fff;font-size:14px;
    }
    .controls .btn{background:linear-gradient(135deg,var(--primary1),var(--primary2));color:#fff;border:none;padding:10px 14px;border-radius:999px;cursor:pointer;font-weight:700}
    .controls .btn.secondary{background:#fff;color:var(--primary1);border:1px solid #e6eefc}
    .controls .btn.danger{background:var(--danger);color:#fff;border:1px solid var(--danger)}
    .responsive-container{width:100%;overflow-x:auto;-webkit-overflow-scrolling:touch;margin-top:12px}
    table{width:100%;border-collapse:collapse;min-width:760px;background:var(--card);border-radius:8px;overflow:hidden}
    thead th{padding:12px;background:linear-gradient(90deg,var(--primary1),var(--primary2));color:#fff;text-align:center}
    th,td{padding:10px;border-bottom:1px solid #f0f4fb;text-align:center;font-size:14px;vertical-align:middle}
    tbody tr:nth-child(even){background:#fbfdff}
    .actions button{margin:0 4px;padding:6px 10px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
    .actions .edit{background:#f59e0b;color:#000}
    .actions .delete{background:var(--danger);color:#fff}
    .actions .save{background:var(--success);color:#fff}
    .actions .cancel{background:#6b7280;color:#fff}
    .badge{display:inline-block;padding:6px 10px;border-radius:999px;background:#eef2ff;color:var(--primary1);font-weight:700}
    .conflicts-table{width:100%;border-collapse:collapse;margin-top:8px;min-width:500px}
    .conflict-type{font-weight:700;color:var(--primary2)}
    .conflict-days{font-weight:700;color:var(--danger)}
    .summary{margin-top:12px;padding:12px;border-radius:10px;background:#ecfeef;color:#064e3b; font-weight:700}
    .muted{color:var(--muted)}
    /* modal */
    .modal{display:none;position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.45);align-items:center;justify-content:center;z-index:9999}
    .modal .box{background:#fff;padding:18px;border-radius:12px;min-width:280px;max-width:480px;box-shadow:var(--shadow)}
    .modal .actions{display:flex;gap:8px;justify-content:center;margin-top:12px}
    
    /* Footer */
    footer{
      background: var(--bg);
      border-top: 1px solid #e6eefc;
      padding: 20px 12px;
      margin-top: auto;
      text-align: center;
    }
    .footer-content{
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
      color: var(--muted);
      font-size: 14px;
    }
    .footer-main{
      font-weight: 600;
      color: var(--primary1);
    }
    .footer-designed{
      font-size: 13px;
    }
    .footer-department{
      font-size: 12px;
      color: var(--muted);
    }

    /* responsive */
    @media (max-width:900px){
      .controls select, .controls input[type="text"]{min-width:160px}
    }
    @media (max-width:640px){
      header .container{flex-direction:column;gap:8px;text-align:center}
      .controls{flex-direction:column;align-items:stretch}
      .controls select, .controls input[type="text"]{width:100%}
      table{min-width:560px}
      .footer-content{
        gap: 6px;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div style="display:flex;align-items:center;gap:12px">
        <div style="width:44px;height:44px;border-radius:8px;background:#fff;display:flex;align-items:center;justify-content:center;font-weight:800;color:var(--primary1)">âš½</div>
        <h1>ØªØ·Ø¨ÙŠÙ‚ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù†ØªØ®Ø§Ø¨Ø§Øª Ø§Ù„Ø£Ù†Ø¯ÙŠØ© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ©</h1>
      </div>
      <div class="muted" style="font-size:13px">Ù…Ø¯ÙŠØ±ÙŠØ© Ø§Ù„Ø´Ø¨Ø§Ø¨ â€” Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ®Ø§Ø¨Ø§Øª</div>
    </div>
  </header>

  <nav>
    <button class="tab active" data-tab="main-tab">Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    <button class="tab" data-tab="backup-tab">Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</button>
  </nav>

  <main>
    <!-- Main Tab -->
    <section id="main-tab" class="tab-content active">
      <div class="panel">
        <div class="controls">
          <select id="clubSelect" aria-label="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù†Ø¯ÙŠØ©">
            <option value="">-- Ø§Ø®ØªØ± Ù†Ø§Ø¯ÙŠÙ‹Ø§ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© --</option>
          </select>

          <button class="btn" onclick="addSelectedClub()">â• Ø¥Ø¶Ø§ÙØ© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>

          <div style="display:flex;gap:8px;align-items:center">
            <input id="newClubName" type="text" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ù†Ø§Ø¯ÙŠ Ø¬Ø¯ÙŠØ¯ (ÙƒØªØ§Ø¨ÙŠ)" />
            <button class="btn" onclick="addNewClubFromInput()">âœï¸ Ø¥Ø¶Ø§ÙØ© Ù†Ø§Ø¯ÙŠ Ø¬Ø¯ÙŠØ¯</button>
            <button class="btn danger" onclick="deleteFromDropdown()">ğŸ—‘ï¸ Ø­Ø°Ù Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
          </div>

          <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
            <button class="btn secondary" onclick="exportCSV()">ğŸ“Š ØªØµØ¯ÙŠØ± Excel (CSV)</button>
            <span class="badge" id="clubsCount">0 Ù†Ø§Ø¯ÙŠ</span>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="responsive-container">
          <table id="clubsTable" aria-label="Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ù†Ø¯ÙŠØ©">
            <thead>
              <tr>
                <th>Ø§Ø³Ù… Ø§Ù„Ù†Ø§Ø¯ÙŠ</th>
                <th>Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø§Ù†ØªØ®Ø§Ø¨Ø§Øª Ø§Ù„Ø£ÙˆÙ„</th>
                <th>Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø§Ù†ØªØ®Ø§Ø¨Ø§Øª Ø§Ù„Ø«Ø§Ù†ÙŠ</th>
                <th>Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªØ³Ø¯ÙŠØ¯</th>
                <th>Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªØ³Ø¯ÙŠØ¯</th>
                <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="panel">
        <h3>Ø§Ù„ØªØ¹Ø§Ø±Ø¶Ø§Øª Ø§Ù„Ù…ÙƒØªØ´ÙØ©</h3>
        <div class="responsive-container" id="conflictsContainer"></div>
      </div>
    </section>

    <!-- Backup Tab -->
    <section id="backup-tab" class="tab-content" style="display:none">
      <div class="panel">
        <h3>Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</h3>
        <p class="muted">ÙŠÙ…ÙƒÙ†Ùƒ ØªØµØ¯ÙŠØ± Ø£Ùˆ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ù†Ø¯ÙŠØ© (JSON). ÙŠØ¯Ø¹Ù… Ù…Ù„Ù Ù…ØµÙÙˆÙØ© Ø£Ùˆ ÙƒØ§Ø¦Ù† Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø¨Ù‡ Ø§Ù„Ø­Ù‚ÙˆÙ„: { clubs: [...], dropdownOptions: [...] }.</p>
        <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:12px">
          <button class="btn" onclick="exportBackup()">ğŸ’¾ ØªØµØ¯ÙŠØ± Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>
          <button class="btn" onclick="triggerImportBackup()">ğŸ“‚ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>
          <button class="btn" onclick="clearAllData()">ğŸ§¹ Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        </div>
        <div style="margin-top:12px;color:var(--muted)">Ø¢Ø®Ø± Ù†Ø³Ø®Ø© Ù…Ø­ÙÙˆØ¸Ø©: <span id="lastBackup">-</span></div>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer>
    <div class="footer-content">
      <div class="footer-main">Â© ØªØ·Ø¨ÙŠÙ‚ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù†ØªØ®Ø§Ø¨Ø§Øª Ø§Ù„Ø£Ù†Ø¯ÙŠØ© 2025</div>
      <div class="footer-designed">Designed by Kh Alm</div>
      <div class="footer-department">Ù…Ø¯ÙŠØ±ÙŠØ© Ø´Ø¨Ø§Ø¨ Ù…Ø­Ø§ÙØ¸Ø© Ø¬Ø±Ø´</div>
    </div>
  </footer>

  <!-- Confirmation Modal -->
  <div id="confirmModal" class="modal" role="dialog" aria-hidden="true">
    <div class="box">
      <div id="confirmText">Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ</div>
      <div class="actions">
        <button class="btn secondary" onclick="closeModal(false)">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn" onclick="closeModal(true)">ØªØ£ÙƒÙŠØ¯</button>
      </div>
    </div>
  </div>

<script>
/* ================= STATE & DEFAULTS ================= */
let clubsData = []; // {id,name,election1,election2,paymentStart,paymentEnd,editing,_backup}
const dropdownDefault = [
  "Ù†Ø§Ø¯ÙŠ Ø§Ù„Ø£Ù‚ØµÙ‰ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ","Ù†Ø§Ø¯ÙŠ Ø¬Ø±Ø´ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ","Ù†Ø§Ø¯ÙŠ Ù…Ø±ØµØ¹ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ","Ù†Ø§Ø¯ÙŠ Ø§Ù„ÙŠØ±Ù…ÙˆÙƒ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ",
  "Ù†Ø§Ø¯ÙŠ ÙƒÙØ±Ø®Ù„ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ","Ù†Ø§Ø¯ÙŠ Ø³Ø§ÙƒØ¨ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ","Ù†Ø§Ø¯ÙŠ Ø§Ù„ÙƒØªÙ‡ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ","Ù†Ø§Ø¯ÙŠ Ù‚ÙÙ‚ÙØ§ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ"
];

/* ================= STARTUP ================= */
document.addEventListener('DOMContentLoaded', () => {
  attachTabs();
  ensureDropdownOptions();
  loadClubsFromStorage();
  renderClubsTable();
  updateStats();
  updateLastBackupDisplay();
});

/* ================= TABS ================= */
function attachTabs(){
  document.querySelectorAll('.tab').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c=>c.style.display='none');
      btn.classList.add('active');
      const id = btn.dataset.tab;
      document.getElementById(id).style.display = 'block';
      if(id === 'backup-tab') updateLastBackupDisplay();
    });
  });
}

/* ================= DROPDOWN ================= */
function ensureDropdownOptions(){
  const select = document.getElementById('clubSelect');
  while(select.options.length > 1) select.remove(1);
  const saved = localStorage.getItem('dropdownOptions');
  const list = saved ? JSON.parse(saved) : dropdownDefault;
  list.forEach(name => {
    const opt = document.createElement('option'); opt.value = name; opt.text = name; select.add(opt);
  });
  if(!saved) localStorage.setItem('dropdownOptions', JSON.stringify(list));
}
function saveDropdownOptions(arr){ try{ localStorage.setItem('dropdownOptions', JSON.stringify(arr)); }catch(e){} }
function getDropdownOptions(){
  const select = document.getElementById('clubSelect');
  const opts = [];
  for(let i=1;i<select.options.length;i++) opts.push(select.options[i].text);
  return opts;
}

// === Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©: Ø­Ø°Ù Ù†Ø§Ø¯ÙŠ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© ===
function deleteFromDropdown(){
  const select = document.getElementById('clubSelect');
  const selectedOption = select.options[select.selectedIndex];
  
  if(!selectedOption || selectedOption.value === ''){
    alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù†Ø§Ø¯ÙŠ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ø­Ø°ÙÙ‡');
    return;
  }
  
  const clubName = selectedOption.text;
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù†Ø§Ø¯ÙŠ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
  if(clubsData.some(c => c.name === clubName)){
    alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø§Ù„Ù†Ø§Ø¯ÙŠ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ø£Ù†Ù‡ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ. ÙŠØ±Ø¬Ù‰ Ø­Ø°ÙÙ‡ Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.');
    return;
  }
  
  showModal('ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©', `Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù†Ø§Ø¯ÙŠ "${escapeHtml(clubName)}" Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©ØŸ`, ()=>{ 
    performDropdownDelete(clubName);
  });
}

function performDropdownDelete(clubName){
  const select = document.getElementById('clubSelect');
  const options = getDropdownOptions();
  const updatedOptions = options.filter(name => name !== clubName);
  
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
  while(select.options.length > 1) select.remove(1);
  updatedOptions.forEach(name => {
    const opt = document.createElement('option'); 
    opt.value = name; 
    opt.text = name; 
    select.add(opt);
  });
  
  // Ø­ÙØ¸ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
  saveDropdownOptions(updatedOptions);
  alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù†Ø§Ø¯ÙŠ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©');
}

/* ================= STORAGE ================= */
function saveClubsToStorage(){
  try{ const toSave = clubsData.map(c => { const {editing,_backup,...rest} = c; return rest; }); localStorage.setItem('clubs', JSON.stringify(toSave)); } catch(e){}
  updateStats();
}
function loadClubsFromStorage(){
  const s = localStorage.getItem('clubs');
  if(s){
    try{ clubsData = JSON.parse(s).map(normalizeClub); } catch(e){ clubsData = []; }
  } else clubsData = [];
}

/* ================= ADD CLUB ================= */
function addSelectedClub(){
  const sel = document.getElementById('clubSelect');
  const name = sel.value;
  if(!name){ alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù†Ø§Ø¯ÙŠ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©'); return; }
  if(clubsData.some(c => c.name === name)){ alert('Ø§Ù„Ù†Ø§Ø¯ÙŠ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„'); sel.value=''; return; }
  clubsData.push({ id: Date.now()+Math.random(), name, election1:'', election2:'', paymentStart:'', paymentEnd:'', editing:false });
  saveClubsToStorage(); renderClubsTable(); sel.value=''; alert('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©');
}
function addNewClubFromInput(){
  const input = document.getElementById('newClubName');
  const name = input.value.trim();
  if(!name){ alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù†Ø§Ø¯ÙŠ'); return; }
  if(clubsData.some(c => c.name === name)){ alert('Ø§Ù„Ù†Ø§Ø¯ÙŠ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„'); input.value=''; return; }
  const select = document.getElementById('clubSelect');
  if(![...select.options].some(o => o.text === name)){
    const opt = document.createElement('option'); opt.value = name; opt.text = name; select.add(opt);
    saveDropdownOptions(getDropdownOptions());
  }
  clubsData.push({ id: Date.now()+Math.random(), name, election1:'', election2:'', paymentStart:'', paymentEnd:'', editing:false });
  saveClubsToStorage(); renderClubsTable(); input.value=''; alert('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ø§Ø¯ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯');
}

/* ================= TABLE RENDER & EDIT ================= */
function renderClubsTable(){
  const tbody = document.querySelector('#clubsTable tbody'); tbody.innerHTML = '';
  // sort by election1 (empty last)
  clubsData.sort((a,b) => (a.election1 || '9999-99-99').localeCompare(b.election1 || '9999-99-99'));
  clubsData.forEach((club, i) => {
    const tr = document.createElement('tr');
    if(club.editing){
      tr.innerHTML = `
        <td><input type="text" value="${escapeHtml(club.name)}" oninput="clubsData[${i}].name=this.value" /></td>
        <td><input type="date" value="${club.election1||''}" onchange="onDateChange(${i},'election1',this.value)" /></td>
        <td><input type="date" value="${club.election2||''}" disabled /></td>
        <td><input type="date" value="${club.paymentStart||''}" onchange="onDateChange(${i},'paymentStart',this.value)" /></td>
        <td><input type="date" value="${club.paymentEnd||''}" disabled /></td>
        <td class="actions">
          <button class="save" onclick="saveEdit(${i})">ğŸ’¾ Ø­ÙØ¸</button>
          <button class="cancel" onclick="cancelEdit(${i})">âŒ Ø¥Ù„ØºØ§Ø¡</button>
        </td>
      `;
    } else {
      tr.innerHTML = `
        <td>${escapeHtml(club.name)}</td>
        <td>${club.election1 || ''}</td>
        <td>${club.election2 || ''}</td>
        <td>${club.paymentStart || ''}</td>
        <td>${club.paymentEnd || ''}</td>
        <td class="actions">
          <button class="edit" onclick="startEdit(${i})">âœï¸</button>
          <button class="delete" onclick="confirmDelete(${i})">ğŸ—‘ï¸</button>
        </td>
      `;
    }
    tbody.appendChild(tr);
  });
  updateStats();
  detectConflicts();
}

/* Edit flow */
function startEdit(index){
  // cancel other edits
  clubsData.forEach((c, idx) => { if(idx !== index){ c.editing = false; delete c._backup; } });
  clubsData[index]._backup = {...clubsData[index]}; // shallow backup
  clubsData[index].editing = true;
  renderClubsTable();
}
function saveEdit(index){
  const club = clubsData[index];
  // ensure election2 and paymentEnd computed if needed
  if(club.election1){
    const d = parseDateSafe(club.election1);
    if(d){ 
      // Ø§Ù„Ø§Ù†ØªØ®Ø§Ø¨Ø§Øª Ø§Ù„Ø«Ø§Ù†ÙŠØ© Ø¨Ø¹Ø¯ 14 ÙŠÙˆÙ… Ù…Ù† Ø§Ù„Ø§Ù†ØªØ®Ø§Ø¨Ø§Øª Ø§Ù„Ø£ÙˆÙ„Ù‰
      const newDate = new Date(d.getTime());
      newDate.setDate(newDate.getDate() + 14);
      club.election2 = dateToISO(newDate); 
    }
  }
  if(club.paymentStart){
    const d = parseDateSafe(club.paymentStart);
    if(d){ 
      // Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªØ³Ø¯ÙŠØ¯ Ø¨Ø¹Ø¯ 9 Ø£ÙŠØ§Ù… Ù…Ù† Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªØ³Ø¯ÙŠØ¯ (10 Ø£ÙŠØ§Ù… Ø¨Ù…Ø§ ÙÙŠÙ‡Ø§ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø£ÙˆÙ„)
      const newDate = new Date(d.getTime());
      newDate.setDate(newDate.getDate() + 9);
      club.paymentEnd = dateToISO(newDate); 
    }
  }
  club.editing = false;
  delete club._backup;
  saveClubsToStorage();
  renderClubsTable();
  alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª');
}
function cancelEdit(index){
  if(clubsData[index]._backup){
    clubsData[index] = {...clubsData[index]._backup, editing:false};
    delete clubsData[index]._backup;
  } else {
    clubsData[index].editing = false;
  }
  renderClubsTable();
}

/* Date change handler (live while editing) */
function onDateChange(index, field, value){
  if(!clubsData[index].editing) return;
  clubsData[index][field] = value;
  
  // elections second auto (+14 days) when user sets election1
  if(field === 'election1' && value){
    const d = parseDateSafe(value);
    if(d){ 
      // Ø§Ù„Ø§Ù†ØªØ®Ø§Ø¨Ø§Øª Ø§Ù„Ø«Ø§Ù†ÙŠØ© Ø¨Ø¹Ø¯ 14 ÙŠÙˆÙ… Ù…Ù† Ø§Ù„Ø§Ù†ØªØ®Ø§Ø¨Ø§Øª Ø§Ù„Ø£ÙˆÙ„Ù‰
      const newDate = new Date(d.getTime());
      newDate.setDate(newDate.getDate() + 14);
      clubsData[index].election2 = dateToISO(newDate); 
    }
  }
  // payment end auto (+9 days) when user sets paymentStart
  if(field === 'paymentStart' && value){
    const d = parseDateSafe(value);
    if(d){ 
      // Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªØ³Ø¯ÙŠØ¯ Ø¨Ø¹Ø¯ 9 Ø£ÙŠØ§Ù… Ù…Ù† Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªØ³Ø¯ÙŠØ¯ (10 Ø£ÙŠØ§Ù… Ø¨Ù…Ø§ ÙÙŠÙ‡Ø§ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø£ÙˆÙ„)
      const newDate = new Date(d.getTime());
      newDate.setDate(newDate.getDate() + 9);
      clubsData[index].paymentEnd = dateToISO(newDate); 
    }
  }
  renderClubsTable();
}

/* ================= DELETE ================= */
let modalCallback = null;
function confirmDelete(idx){
  showModal('ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù', `Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù†Ø§Ø¯ÙŠ "${escapeHtml(clubsData[idx].name)}"ØŸ`, ()=>{ performDelete(idx); });
}
function performDelete(idx){
  clubsData.splice(idx,1);
  saveClubsToStorage();
  renderClubsTable();
  alert('ØªÙ… Ø§Ù„Ø­Ø°Ù');
}

/* ================= CONFLICTS DETECTION ================= */
/* returns {days,start:Date,end:Date} inclusive */
function getOverlapRange(s1,e1,s2,e2){
  const a1 = parseDateSafe(s1), b1 = parseDateSafe(e1), a2 = parseDateSafe(s2), b2 = parseDateSafe(e2);
  if(!a1 || !b1 || !a2 || !b2) return {days:0};
  const latestStart = a1 > a2 ? a1 : a2;
  const earliestEnd = b1 < b2 ? b1 : b2;
  if(earliestEnd < latestStart) return {days:0};
  const days = Math.floor((earliestEnd.getTime() - latestStart.getTime())/(1000*60*60*24)) + 1;
  return {days, start: latestStart, end: earliestEnd};
}

function detectConflicts(){
  const conflicts = [];
  for(let i=0;i<clubsData.length;i++){
    for(let j=i+1;j<clubsData.length;j++){
      const A = clubsData[i], B = clubsData[j];
      
      // payment vs payment
      if(A.paymentStart && A.paymentEnd && B.paymentStart && B.paymentEnd){
        const ov = getOverlapRange(A.paymentStart,A.paymentEnd,B.paymentStart,B.paymentEnd);
        if(ov.days>0) conflicts.push({type:'ØªØ³Ø¯ÙŠØ¯ Ù…Ø¹ ØªØ³Ø¯ÙŠØ¯', club1:A.name, club2:B.name, start:ov.start, end:ov.end, days:ov.days});
      }
      
      // elections vs payment (Ø§Ù„Ø§Ù†ØªØ®Ø§Ø¨Ø§Øª Ø§Ù„Ø£ÙˆÙ„Ù‰ ÙÙ‚Ø·)
      if(A.election1 && B.paymentStart && B.paymentEnd){
        const ov = getOverlapRange(A.election1,A.election1,B.paymentStart,B.paymentEnd);
        if(ov.days>0) conflicts.push({type:'Ø§Ù†ØªØ®Ø§Ø¨Ø§Øª Ù…Ø¹ ØªØ³Ø¯ÙŠØ¯', club1:A.name, club2:B.name, start:ov.start, end:ov.end, days:ov.days});
      }
      if(B.election1 && A.paymentStart && A.paymentEnd){
        const ov = getOverlapRange(B.election1,B.election1,A.paymentStart,A.paymentEnd);
        if(ov.days>0) conflicts.push({type:'Ø§Ù†ØªØ®Ø§Ø¨Ø§Øª Ù…Ø¹ ØªØ³Ø¯ÙŠØ¯', club1:B.name, club2:A.name, start:ov.start, end:ov.end, days:ov.days});
      }
      
      // elections vs elections (Ø§Ù„Ø§Ù†ØªØ®Ø§Ø¨Ø§Øª Ø§Ù„Ø£ÙˆÙ„Ù‰ ÙÙ‚Ø·)
      if(A.election1 && B.election1){
        const ov = getOverlapRange(A.election1,A.election1,B.election1,B.election1);
        if(ov.days>0) conflicts.push({type:'Ø§Ù†ØªØ®Ø§Ø¨Ø§Øª Ù…Ø¹ Ø§Ù†ØªØ®Ø§Ø¨Ø§Øª', club1:A.name, club2:B.name, start:ov.start, end:ov.end, days:ov.days});
      }
    }
  }
  renderConflicts(conflicts);
}

function renderConflicts(conflicts){
  const container = document.getElementById('conflictsContainer'); container.innerHTML = '';
  if(!conflicts || conflicts.length === 0){ container.innerHTML = '<div style="padding:12px">âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¹Ø§Ø±Ø¶Ø§Øª</div>'; return; }
  const table = document.createElement('table'); table.className = 'conflicts-table';
  let html = `<thead><tr><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ø£Ù†Ø¯ÙŠØ©</th><th>Ù†Ø·Ø§Ù‚ Ø§Ù„ØªØ¯Ø§Ø®Ù„</th><th>Ø§Ù„Ø£ÙŠØ§Ù…</th></tr></thead><tbody>`;
  let total = 0;
  conflicts.forEach(c=>{
    const s = formatDateDisplay(c.start), e = formatDateDisplay(c.end);
    const range = (s === e) ? s : `${s} - ${e}`;
    html += `<tr>
      <td class="conflict-type">${escapeHtml(c.type)}</td>
      <td>${escapeHtml(c.club1)} âš”ï¸ ${escapeHtml(c.club2)}</td>
      <td>${escapeHtml(range)}</td>
      <td class="conflict-days">${c.days} ÙŠÙˆÙ…</td>
    </tr>`;
    total += c.days;
  });
  html += `<tr style="background:#f8faf8;font-weight:700"><td colspan="3">Ù…Ø¬Ù…ÙˆØ¹ Ø£ÙŠØ§Ù… Ø§Ù„ØªØ¹Ø§Ø±Ø¶Ø§Øª</td><td>${total} ÙŠÙˆÙ…</td></tr>`;
  html += `</tbody>`;
  table.innerHTML = html;
  container.appendChild(table);
}

/* ================= EXPORT / IMPORT / CLEAR ================= */
function exportBackup(){
  const payload = { version:'1.0', exportDate: new Date().toISOString(), clubs: clubsData.map(c=>{ const {editing,_backup,...rest}=c; return rest; }), dropdownOptions: getDropdownOptions() };
  const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json;charset=utf-8'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = `backup-clubs-${new Date().toISOString().split('T')[0]}.json`; a.click();
  localStorage.setItem('lastBackup', new Date().toISOString()); updateLastBackupDisplay();
  alert('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©');
}

function triggerImportBackup(){
  const input = document.createElement('input'); input.type='file'; input.accept='.json';
  input.onchange = ()=> {
    const file = input.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      try {
        const parsed = JSON.parse(e.target.result);
        if(Array.isArray(parsed)){
          if(!confirm('Ø§Ù„Ù…Ù„Ù ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…ØµÙÙˆÙØ© Ø£Ù†Ø¯ÙŠØ© Ù…Ø¨Ø§Ø´Ø±Ø©. Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©ØŸ')) return;
          clubsData = parsed.map(normalizeClub);
        } else if(parsed && parsed.clubs){
          if(!confirm('Ø§Ù„Ù…Ù„Ù ÙŠØ¨Ø¯Ùˆ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©. Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©ØŸ')) return;
          clubsData = parsed.clubs.map(normalizeClub);
          if(parsed.dropdownOptions && Array.isArray(parsed.dropdownOptions)){
            const select = document.getElementById('clubSelect');
            while(select.options.length>1) select.remove(1);
            parsed.dropdownOptions.forEach(name => { const opt=document.createElement('option'); opt.value=name; opt.text=name; select.add(opt); });
            saveDropdownOptions(parsed.dropdownOptions);
          }
        } else {
          alert('ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ù‡ JSON Ø¨ØµÙŠØºØ© ØµØ­ÙŠØ­Ø©.');
          return;
        }
        saveClubsToStorage(); renderClubsTable(); alert('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
      } catch(err){
        alert('Ø®Ø·Ø£ Ø¹Ù†Ø¯ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù: ' + err.message);
      }
    };
    reader.readAsText(file);
  };
  input.click();
}

function clearAllData(){
  if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ')) return;
  clubsData = []; localStorage.removeItem('clubs'); localStorage.removeItem('dropdownOptions'); ensureDropdownOptions();
  saveClubsToStorage(); renderClubsTable(); updateLastBackupDisplay(); alert('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
}

/* Simple CSV exporter (Excel friendly) */
function exportCSV(){
  const rows = [['Ø§Ø³Ù… Ø§Ù„Ù†Ø§Ø¯ÙŠ','Ø§Ù„Ø§Ù†ØªØ®Ø§Ø¨Ø§Øª 1','Ø§Ù„Ø§Ù†ØªØ®Ø§Ø¨Ø§Øª 2','Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªØ³Ø¯ÙŠØ¯','Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªØ³Ø¯ÙŠØ¯']];
  clubsData.forEach(c => rows.push([c.name || '', c.election1 || '', c.election2 || '', c.paymentStart || '', c.paymentEnd || '']));
  const csv = rows.map(r => r.map(cell => `"${(cell+'').replace(/"/g,'""')}"`).join(',')).join('\r\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `clubs-${new Date().toISOString().split('T')[0]}.csv`; a.click();
}

/* ================= HELPERS ================= */
function normalizeClub(obj){
  return {
    id: obj.id || Date.now() + Math.floor(Math.random()*10000),
    name: (obj.name || obj.title || obj.club || '').toString(),
    election1: obj.election1 || '',
    election2: obj.election2 || '',
    paymentStart: obj.paymentStart || '',
    paymentEnd: obj.paymentEnd || '',
    editing: false
  };
}

function parseDateSafe(s){
  if(!s) return null;
  // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ ØªÙ†Ø³ÙŠÙ‚ YYYY-MM-DD Ù…Ø¨Ø§Ø´Ø±Ø©
  if(typeof s === 'string' && s.match(/^\d{4}-\d{2}-\d{2}$/)) {
    const parts = s.split('-');
    const year = parseInt(parts[0]);
    const month = parseInt(parts[1]) - 1; // Ø§Ù„Ø£Ø´Ù‡Ø± Ù…Ù† 0-11
    const day = parseInt(parts[2]);
    return new Date(year, month, day);
  }
  if(s instanceof Date) return new Date(s.getFullYear(), s.getMonth(), s.getDate());
  const d = new Date(s); 
  return isNaN(d.getTime()) ? null : new Date(d.getFullYear(), d.getMonth(), d.getDate());
}
function dateToISO(d){ 
  if(!d) return '';
  const year = d.getFullYear();
  const month = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}
function formatDateDisplay(d){
  const dt = (d instanceof Date) ? d : parseDateSafe(d);
  if(!dt) return '';
  return `${String(dt.getDate()).padStart(2,'0')}/${String(dt.getMonth()+1).padStart(2,'0')}/${dt.getFullYear()}`;
}
function escapeHtml(s){ if(s===undefined || s===null) return ''; return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }

/* UI small helpers */
function updateStats(){ document.getElementById('clubsCount').textContent = `${clubsData.length} Ù†Ø§Ø¯ÙŠ`; }
function updateLastBackupDisplay(){ const s = localStorage.getItem('lastBackup'); document.getElementById('lastBackup').textContent = s ? (new Date(s)).toLocaleString() : 'Ù„Ø§ ØªÙˆØ¬Ø¯'; }

/* Modal */
function showModal(title, message, onConfirm){
  modalCallback = onConfirm;
  const modal = document.getElementById('confirmModal'); const box = modal.querySelector('.box');
  const prev = box.querySelector('#confirmText'); if(prev) prev.remove();
  const txt = document.createElement('div'); txt.id='confirmText'; txt.innerHTML = `<strong>${escapeHtml(title)}</strong><p style="margin-top:8px">${escapeHtml(message)}</p>`;
  box.insertBefore(txt, box.querySelector('.actions'));
  modal.style.display = 'flex';
}
function closeModal(confirmed){
  const modal = document.getElementById('confirmModal'); modal.style.display = 'none';
  if(confirmed && typeof modalCallback === 'function') modalCallback();
  modalCallback = null;
}

/* Expose small functions for console debugging if needed */
window._save = saveClubsToStorage;
window._load = loadClubsFromStorage;

</script>
</body>
</html>
