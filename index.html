<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>تطبيق مواعيد انتخابات الأندية الرياضية</title>
  <style>
    :root{
      --bg:#f4f6fb; --card:#fff; --primary1:#2563eb; --primary2:#7c3aed;
      --muted:#6b7280; --danger:#ef4444; --success:#16a34a; --shadow:0 8px 24px rgba(0,0,0,0.08);
      --radius:12px;
    }
    *{box-sizing:border-box}
    body{
      font-family: "Cairo", "Tahoma", Arial, sans-serif;
      direction: rtl;
      margin:0;
      background:var(--bg);
      color:#111827;
      -webkit-font-smoothing:antialiased;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    header{
      background: linear-gradient(135deg,var(--primary1),var(--primary2));
      color:#fff;
      padding:18px 12px;
      box-shadow:var(--shadow);
    }
    header .container{
      max-width:1200px;
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    header h1{margin:0;font-size:18px;font-weight:700}
    nav{max-width:1200px;margin:12px auto 0;display:flex;gap:0;padding:0 12px}
    .tab{
      flex:1;padding:12px;border:none;background:#fff;border-radius:10px 10px 0 0;cursor:pointer;font-weight:600;color:#374151;
      border-bottom:3px solid transparent;transition:all .18s;
    }
    .tab.active{color:var(--primary1);border-bottom-color:var(--primary1);background:#fff}
    main{
      max-width:1200px;
      margin:16px auto;
      padding:0 12px;
      flex:1;
      width:100%;
    }
    .panel{background:var(--card);padding:16px;border-radius:var(--radius);box-shadow:var(--shadow);margin-bottom:16px}
    .controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .controls select, .controls input[type="text"]{
      padding:10px;border-radius:10px;border:1px solid #e6eefc;min-width:220px;background:#fff;font-size:14px;
    }
    .controls .btn{background:linear-gradient(135deg,var(--primary1),var(--primary2));color:#fff;border:none;padding:10px 14px;border-radius:999px;cursor:pointer;font-weight:700}
    .controls .btn.secondary{background:#fff;color:var(--primary1);border:1px solid #e6eefc}
    .controls .btn.danger{background:var(--danger);color:#fff;border:1px solid var(--danger)}
    .responsive-container{width:100%;overflow-x:auto;-webkit-overflow-scrolling:touch;margin-top:12px}
    table{width:100%;border-collapse:collapse;min-width:760px;background:var(--card);border-radius:8px;overflow:hidden}
    thead th{padding:12px;background:linear-gradient(90deg,var(--primary1),var(--primary2));color:#fff;text-align:center}
    th,td{padding:10px;border-bottom:1px solid #f0f4fb;text-align:center;font-size:14px;vertical-align:middle}
    tbody tr:nth-child(even){background:#fbfdff}
    .actions button{margin:0 4px;padding:6px 10px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
    .actions .edit{background:#f59e0b;color:#000}
    .actions .delete{background:var(--danger);color:#fff}
    .actions .save{background:var(--success);color:#fff}
    .actions .cancel{background:#6b7280;color:#fff}
    .badge{display:inline-block;padding:6px 10px;border-radius:999px;background:#eef2ff;color:var(--primary1);font-weight:700}
    .conflicts-table{width:100%;border-collapse:collapse;margin-top:8px;min-width:500px}
    .conflict-type{font-weight:700;color:var(--primary2)}
    .conflict-days{font-weight:700;color:var(--danger)}
    .summary{margin-top:12px;padding:12px;border-radius:10px;background:#ecfeef;color:#064e3b; font-weight:700}
    .muted{color:var(--muted)}
    /* modal */
    .modal{display:none;position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.45);align-items:center;justify-content:center;z-index:9999}
    .modal .box{background:#fff;padding:18px;border-radius:12px;min-width:280px;max-width:480px;box-shadow:var(--shadow)}
    .modal .actions{display:flex;gap:8px;justify-content:center;margin-top:12px}
    
    /* Footer */
    footer{
      background: var(--bg);
      border-top: 1px solid #e6eefc;
      padding: 20px 12px;
      margin-top: auto;
      text-align: center;
    }
    .footer-content{
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
      color: var(--muted);
      font-size: 14px;
    }
    .footer-main{
      font-weight: 600;
      color: var(--primary1);
    }
    .footer-designed{
      font-size: 13px;
    }
    .footer-department{
      font-size: 12px;
      color: var(--muted);
    }

    /* responsive */
    @media (max-width:900px){
      .controls select, .controls input[type="text"]{min-width:160px}
    }
    @media (max-width:640px){
      header .container{flex-direction:column;gap:8px;text-align:center}
      .controls{flex-direction:column;align-items:stretch}
      .controls select, .controls input[type="text"]{width:100%}
      table{min-width:560px}
      .footer-content{
        gap: 6px;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div style="display:flex;align-items:center;gap:12px">
        <div style="width:44px;height:44px;border-radius:8px;background:#fff;display:flex;align-items:center;justify-content:center;font-weight:800;color:var(--primary1)">⚽</div>
        <h1>تطبيق مواعيد انتخابات الأندية الرياضية</h1>
      </div>
      <div class="muted" style="font-size:13px">Kh Alm — © تطبيق مواعيد انتخابات الأندية 2025 ©  </div>
    </div>
  </header>

  <nav>
    <button class="tab active" data-tab="main-tab">الصفحة الرئيسية</button>
    <button class="tab" data-tab="cycles-tab">الدورات الانتخابية</button>
    <button class="tab" data-tab="backup-tab">النسخ الاحتياطي</button>
  </nav>

  <main>
    <!-- Main Tab -->
    <section id="main-tab" class="tab-content active">
      <div class="panel">
        <div class="controls">
          <select id="clubSelect" aria-label="قائمة الأندية">
            <option value="">-- اختر ناديًا من القائمة --</option>
          </select>

          <button class="btn" onclick="addSelectedClub()">➕ إضافة من القائمة</button>

          <div style="display:flex;gap:8px;align-items:center">
            <input id="newClubName" type="text" placeholder="أدخل اسم نادي جديد (كتابي)" />
            <button class="btn" onclick="addNewClubFromInput()">✍️ إضافة نادي جديد</button>
            <button class="btn danger" onclick="deleteFromDropdown()">🗑️ حذف من القائمة</button>
          </div>

          <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
            <button class="btn secondary" onclick="exportCSV()">📊 تصدير Excel (CSV)</button>
            <span class="badge" id="clubsCount">0 نادي</span>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="responsive-container">
          <table id="clubsTable" aria-label="جدول الأندية">
            <thead>
              <tr>
                <th>اسم النادي</th>
                <th>موعد الانتخابات الأول</th>
                <th>موعد الانتخابات الثاني</th>
                <th>بداية التسديد</th>
                <th>نهاية التسديد</th>
                <th>إجراءات</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="panel">
        <h3>التعارضات المكتشفة</h3>
        <div class="responsive-container" id="conflictsContainer"></div>
      </div>
    </section>
    <!-- Election Cycles Tab -->
    <section id="cycles-tab" class="tab-content" style="display:none">
      <!-- Reconciliation Dates Section -->
      <div class="panel">
        <h3>📅 تواريخ توفيق الأنظمة الداخلية للأندية</h3>
        <p class="muted">تاريخ توفيق النظام الداخلي هو التاريخ  الذي يحدد بداية احتساب الدورات الإنتخابية أي دورة بدأت قبل هذا التاريخ لا تحسب ضمن الثلاث دورات.</p>
        <div class="controls">
          <select id="clubSelectReconciliation">
            <option value="">-- اختر النادي --</option>
          </select>
          <input type="text" id="reconciliationDateInput" placeholder="تاريخ التوفيق (يوم/شهر/سنة)" style="min-width:200px">
          <button class="btn" onclick="setReconciliationDate()">💾 حفظ تاريخ التوفيق</button>
        </div>
        
        <div class="responsive-container">
          <table id="reconciliationDatesTable">
            <thead>
              <tr>
                <th>النادي</th>
                <th>تاريخ توفيق النظام الداخلي</th>
                <th>إجراءات</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="panel">
        <h3>إضافة رئيس لنادي جديد</h3>
        <div class="controls">
          <input id="presidentName" type="text" placeholder="اسم الرئيس" />
          <select id="presidentClubSelect" aria-label="اختر النادي">
            <option value="">-- اختر النادي --</option>
          </select>
          <input id="cycleStartDate" type="text" placeholder="تاريخ بداية الدورة (يوم/شهر/سنة)" />
          <button class="btn" onclick="addNewPresident()">➕ إضافة رئيس جديد</button>
        </div>
      </div>

      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <h3 style="margin:0">رؤساء الأندية</h3>
          <div style="display:flex;gap:8px">
            <span class="badge" id="presidentsCount">0 رئيس</span>
            <span class="badge" style="background:#d1fae5;color:#065f46" id="eligibleCount">0 مؤهل</span>
            <span class="badge" style="background:#fee2e2;color:#991b1b" id="ineligibleCount">0 ممنوع</span>
          </div>
        </div>
        <div class="responsive-container">
          <table id="presidentsTable" aria-label="جدول الرؤساء">
            <thead>
              <tr>
                <th>اسم الرئيس</th>
                <th>اسم النادي</th>
                <th>إجمالي الدورات</th>
                <th>الدورات المحسوبة</th>
                <th>الدورات المتتالية</th>
                <th>حالة الأهلية</th>
                <th>التاريخ التالي للترشح</th>
                <th>إجراءات</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

          </section>

    <!-- Backup Tab -->
    <section id="backup-tab" class="tab-content" style="display:none">
      <div class="panel">
        <h3>نظام النسخ الاحتياطي</h3>
        <p class="muted">يمكنك تصدير أو استيراد بيانات مواعيد اانتخابات الأندية (JSON) يدعم ملف </p>
        <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:12px">
          <button class="btn" onclick="exportBackup()">💾 تصدير النسخة الاحتياطية</button>
          <button class="btn" onclick="triggerImportBackup()">📂 استيراد النسخة الاحتياطية</button>
          <button class="btn" onclick="clearAllData()">🧹 مسح كل البيانات</button>
        </div>
        <div style="margin-top:12px;color:var(--muted)">آخر نسخة محفوظة: <span id="lastBackup">-</span></div>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer>
    <div class="footer-content">
      <div class="footer-main">© تطبيق مواعيد انتخابات الأندية 2025</div>
      <div class="footer-designed">Designed by Kh Alm</div>
      <div class="footer-department">مديرية شباب محافظة جرش</div>
    </div>
  </footer>

  <!-- Confirmation Modal -->
  <div id="confirmModal" class="modal" role="dialog" aria-hidden="true">
    <div class="box">
      <div id="confirmText">هل تريد المتابعة؟</div>
      <div class="actions">
        <button class="btn secondary" onclick="closeModal(false)">إلغاء</button>
        <button class="btn" onclick="closeModal(true)">تأكيد</button>
      </div>
    </div>
  </div>

  <!-- Cycles Details Modal -->
  <div id="cyclesModal" class="modal" role="dialog" aria-hidden="true">
    <div class="box" style="max-width:700px">
      <h3 id="cyclesModalTitle" style="margin-top:0">تفاصيل دورات الرئيس</h3>
      <div id="cyclesModalContent"></div>
      <div class="actions">
        <button class="btn secondary" onclick="closeCyclesModal()">إغلاق</button>
      </div>
    </div>
  </div>

<script>
/* ================= الحالة و الوضع الافتراضي ================= */
let clubsData = []; // {id,name,election1,election2,paymentStart,paymentEnd,editing,_backup}
let presidentsData = []; // {id,name,clubName,cycles:[{cycleNumber,startDate,endDate,status,countable}],totalCycles,countableCycles,consecutiveCycles,canNominate,nextEligibleDate}
let clubsReconciliation = {}; // {clubName: reconciliationDate}
const dropdownDefault = [
  "نادي جرش الرياضي","نادي الأقصى الرياضي","نادي مرصع الرياضي","نادي شباب المصطبة الرياضي",
  "نادي كفرخل الرياضي","نادي ساكب الرياضي","نادي إتحاد جرش الرياضي","نادي الكتة الرياضي","نادي شباب سوف الرياضي","نادي شباب ريمون الرياضي","نادي شباب الفيحاء الرياضي","نادي شباب مرصع الرياضي","نادي جبة الرياضي","نادي شباب جبة الرياضي","نادي نحلة الرياضي","نادي غزة هاشم الرياضي","نادي الرشايدة الرياضي","نادي قفقفا الرياضي"
];

/* ================= البداية ================= */
document.addEventListener('DOMContentLoaded', () => {
  attachTabs();
  ensureDropdownOptions();
  loadClubsFromStorage();
  renderClubsTable();
  updateStats();
  loadReconciliationDates();
  renderReconciliationTable();
  loadPresidentsFromStorage();
  renderPresidentsTable();
  updatePresidentsStats();
  updateLastBackupDisplay();
});

/* ================= علامات التبويب ================= */
function attachTabs(){
  document.querySelectorAll('.tab').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c=>c.style.display='none');
      btn.classList.add('active');
      const id = btn.dataset.tab;
      document.getElementById(id).style.display = 'block';
      if(id === 'backup-tab') updateLastBackupDisplay();
      if(id === 'cycles-tab') {
        populateReconciliationClubSelect();
        populatePresidentClubSelect();
        renderReconciliationTable();
        renderPresidentsTable();
        updatePresidentsStats();
      }
    });
  });
}

function ensureDropdownOptions(){
  const select = document.getElementById('clubSelect');
  while(select.options.length > 1) select.remove(1);
  const saved = localStorage.getItem('dropdownOptions');
  const list = saved ? JSON.parse(saved) : dropdownDefault;
  list.forEach(name => {
    const opt = document.createElement('option'); opt.value = name; opt.text = name; select.add(opt);
  });
  if(!saved) localStorage.setItem('dropdownOptions', JSON.stringify(list));
}
function saveDropdownOptions(arr){ try{ localStorage.setItem('dropdownOptions', JSON.stringify(arr)); }catch(e){} }
function getDropdownOptions(){
  const select = document.getElementById('clubSelect');
  const opts = [];
  for(let i=1;i<select.options.length;i++) opts.push(select.options[i].text);
  return opts;
}

// ===  حذف نادي من القائمة المنسدلة ===
function deleteFromDropdown(){
  const select = document.getElementById('clubSelect');
  const selectedOption = select.options[select.selectedIndex];
  
  if(!selectedOption || selectedOption.value === ''){
    alert('الرجاء اختيار نادي من القائمة لحذفه');
    return;
  }
  
  const clubName = selectedOption.text;
  
  // التحقق إذا كان النادي موجود في الجدول الرئيسي
  if(clubsData.some(c => c.name === clubName)){
    alert('لا يمكن حذف النادي من القائمة لأنه موجود في الجدول الرئيسي يرجى حذفه من الجدول أولا.');
    return;
  }
  
  showModal('تأكيد الحذف من القائمة', `هل تريد حذف النادي "${escapeHtml(clubName)}" من القائمة المنسدلة؟`, ()=>{ 
    performDropdownDelete(clubName);
  });
}

function performDropdownDelete(clubName){
  const select = document.getElementById('clubSelect');
  const options = getDropdownOptions();
  const updatedOptions = options.filter(name => name !== clubName);
  
  // تحديث القائمة المنسدلة
  while(select.options.length > 1) select.remove(1);
  updatedOptions.forEach(name => {
    const opt = document.createElement('option'); 
    opt.value = name; 
    opt.text = name; 
    select.add(opt);
  });
  
  // حفظ القائمة المحدثة
  saveDropdownOptions(updatedOptions);
  alert('تم حذف النادي من القائمة المنسدلة');
}

/* ================= التخزين ================= */
function saveClubsToStorage(){
  try{ const toSave = clubsData.map(c => { const {editing,_backup,...rest} = c; return rest; }); localStorage.setItem('clubs', JSON.stringify(toSave)); } catch(e){}
  updateStats();
}
function loadClubsFromStorage(){
  const s = localStorage.getItem('clubs');
  if(s){
    try{ clubsData = JSON.parse(s).map(normalizeClub); } catch(e){ clubsData = []; }
  } else clubsData = [];
}

/* ================= اضافة نادي ================= */
function addSelectedClub(){
  const sel = document.getElementById('clubSelect');
  const name = sel.value;
  if(!name){ alert('الرجاء اختيار نادي من القائمة'); return; }
  if(clubsData.some(c => c.name === name)){ alert('النادي موجود بالفعل'); sel.value=''; return; }
  clubsData.push({ id: Date.now()+Math.random(), name, election1:'', election2:'', paymentStart:'', paymentEnd:'', editing:false });
  saveClubsToStorage(); renderClubsTable(); sel.value=''; alert('تمت الإضافة');
}
function addNewClubFromInput(){
  const input = document.getElementById('newClubName');
  const name = input.value.trim();
  if(!name){ alert('أدخل اسم النادي'); return; }
  if(clubsData.some(c => c.name === name)){ alert('النادي موجود بالفعل'); input.value=''; return; }
  const select = document.getElementById('clubSelect');
  if(![...select.options].some(o => o.text === name)){
    const opt = document.createElement('option'); opt.value = name; opt.text = name; select.add(opt);
    saveDropdownOptions(getDropdownOptions());
  }
  clubsData.push({ id: Date.now()+Math.random(), name, election1:'', election2:'', paymentStart:'', paymentEnd:'', editing:false });
  saveClubsToStorage(); renderClubsTable(); input.value=''; alert('تمت إضافة النادي الجديد');
}

/* ================= الجداول ================= */
function renderClubsTable(){
  const tbody = document.querySelector('#clubsTable tbody'); tbody.innerHTML = '';
  // sort by election1 (empty last)
  clubsData.sort((a,b) => (a.election1 || '9999-99-99').localeCompare(b.election1 || '9999-99-99'));
  clubsData.forEach((club, i) => {
    const tr = document.createElement('tr');
    if(club.editing){
      tr.innerHTML = `
        <td><input type="text" value="${escapeHtml(club.name)}" oninput="clubsData[${i}].name=this.value" /></td>
        <td><input type="date" value="${club.election1||''}" onchange="onDateChange(${i},'election1',this.value)" /></td>
        <td><input type="date" value="${club.election2||''}" disabled /></td>
        <td><input type="date" value="${club.paymentStart||''}" onchange="onDateChange(${i},'paymentStart',this.value)" /></td>
        <td><input type="date" value="${club.paymentEnd||''}" disabled /></td>
        <td class="actions">
          <button class="save" onclick="saveEdit(${i})">💾 حفظ</button>
          <button class="cancel" onclick="cancelEdit(${i})">❌ إلغاء</button>
        </td>
      `;
    } else {
      tr.innerHTML = `
        <td>${escapeHtml(club.name)}</td>
        <td>${club.election1 || ''}</td>
        <td>${club.election2 || ''}</td>
        <td>${club.paymentStart || ''}</td>
        <td>${club.paymentEnd || ''}</td>
        <td class="actions">
          <button class="edit" onclick="startEdit(${i})">✏️</button>
          <button class="delete" onclick="confirmDelete(${i})">🗑️</button>
        </td>
      `;
    }
    tbody.appendChild(tr);
  });
  updateStats();
  detectConflicts();
}

/* Edit flow */
function startEdit(index){
  // cancel other edits
  clubsData.forEach((c, idx) => { if(idx !== index){ c.editing = false; delete c._backup; } });
  clubsData[index]._backup = {...clubsData[index]}; // shallow backup
  clubsData[index].editing = true;
  renderClubsTable();
}
function saveEdit(index){
  const club = clubsData[index];
  // ensure election2 and paymentEnd computed if needed
  if(club.election1){
    const d = parseDateSafe(club.election1);
    if(d){ 
      // الانتخابات الثانية بعد 14 يوم من الانتخابات الأولى
      const newDate = new Date(d.getTime());
      newDate.setDate(newDate.getDate() + 14);
      club.election2 = dateToISO(newDate); 
    }
  }
  if(club.paymentStart){
    const d = parseDateSafe(club.paymentStart);
    if(d){ 
      // نهاية التسديد بعد 9 أيام من بداية التسديد (10 أيام بما فيها اليوم الأول)
      const newDate = new Date(d.getTime());
      newDate.setDate(newDate.getDate() + 9);
      club.paymentEnd = dateToISO(newDate); 
    }
  }
  club.editing = false;
  delete club._backup;
  saveClubsToStorage();
  renderClubsTable();
  alert('تم حفظ التعديلات');
}
function cancelEdit(index){
  if(clubsData[index]._backup){
    clubsData[index] = {...clubsData[index]._backup, editing:false};
    delete clubsData[index]._backup;
  } else {
    clubsData[index].editing = false;
  }
  renderClubsTable();
}

/* Date change handler (live while editing) */
function onDateChange(index, field, value){
  if(!clubsData[index].editing) return;
  clubsData[index][field] = value;
  
  // elections second auto (+14 days) when user sets election1
  if(field === 'election1' && value){
    const d = parseDateSafe(value);
    if(d){ 
      // الانتخابات الثانية بعد 14 يوم من الانتخابات الأولى
      const newDate = new Date(d.getTime());
      newDate.setDate(newDate.getDate() + 14);
      clubsData[index].election2 = dateToISO(newDate); 
    }
  }
  // payment end auto (+9 days) when user sets paymentStart
  if(field === 'paymentStart' && value){
    const d = parseDateSafe(value);
    if(d){ 
      // نهاية التسديد بعد 9 أيام من بداية التسديد (10 أيام بما فيها اليوم الأول)
      const newDate = new Date(d.getTime());
      newDate.setDate(newDate.getDate() + 9);
      clubsData[index].paymentEnd = dateToISO(newDate); 
    }
  }
  renderClubsTable();
}

/* ================= الحذف للاندية ================= */
let modalCallback = null;
function confirmDelete(idx){
  showModal('تأكيد الحذف', `هل تريد حذف النادي "${escapeHtml(clubsData[idx].name)}"؟`, ()=>{ performDelete(idx); });
}
function performDelete(idx){
  clubsData.splice(idx,1);
  saveClubsToStorage();
  renderClubsTable();
  alert('تم الحذف');
}

/* ================= كشف التعارض ================= */
/* returns {days,start:Date,end:Date} inclusive */
function getOverlapRange(s1,e1,s2,e2){
  const a1 = parseDateSafe(s1), b1 = parseDateSafe(e1), a2 = parseDateSafe(s2), b2 = parseDateSafe(e2);
  if(!a1 || !b1 || !a2 || !b2) return {days:0};
  const latestStart = a1 > a2 ? a1 : a2;
  const earliestEnd = b1 < b2 ? b1 : b2;
  if(earliestEnd < latestStart) return {days:0};
  const days = Math.floor((earliestEnd.getTime() - latestStart.getTime())/(1000*60*60*24)) + 1;
  return {days, start: latestStart, end: earliestEnd};
}

function detectConflicts(){
  const conflicts = [];
  for(let i=0;i<clubsData.length;i++){
    for(let j=i+1;j<clubsData.length;j++){
      const A = clubsData[i], B = clubsData[j];
      
      // التسديد مقابل التسديد
      if(A.paymentStart && A.paymentEnd && B.paymentStart && B.paymentEnd){
        const ov = getOverlapRange(A.paymentStart,A.paymentEnd,B.paymentStart,B.paymentEnd);
        if(ov.days>0) conflicts.push({type:'تسديد مع تسديد', club1:A.name, club2:B.name, start:ov.start, end:ov.end, days:ov.days});
      }
      
      //الانتخابات مقابل التسديد (الانتخابات الأولى فقط)
      if(A.election1 && B.paymentStart && B.paymentEnd){
        const ov = getOverlapRange(A.election1,A.election1,B.paymentStart,B.paymentEnd);
        if(ov.days>0) conflicts.push({type:'انتخابات مع تسديد', club1:A.name, club2:B.name, start:ov.start, end:ov.end, days:ov.days});
      }
      if(B.election1 && A.paymentStart && A.paymentEnd){
        const ov = getOverlapRange(B.election1,B.election1,A.paymentStart,A.paymentEnd);
        if(ov.days>0) conflicts.push({type:'انتخابات مع تسديد', club1:B.name, club2:A.name, start:ov.start, end:ov.end, days:ov.days});
      }
      
      // الانتخابات مقابل الانتخابات (الانتخابات الأولى فقط)
      if(A.election1 && B.election1){
        const ov = getOverlapRange(A.election1,A.election1,B.election1,B.election1);
        if(ov.days>0) conflicts.push({type:'انتخابات مع انتخابات', club1:A.name, club2:B.name, start:ov.start, end:ov.end, days:ov.days});
      }
    }
  }
  renderConflicts(conflicts);
}

function renderConflicts(conflicts){
  const container = document.getElementById('conflictsContainer'); container.innerHTML = '';
  if(!conflicts || conflicts.length === 0){ container.innerHTML = '<div style="padding:12px">✅ لا توجد تعارضات</div>'; return; }
  const table = document.createElement('table'); table.className = 'conflicts-table';
  let html = `<thead><tr><th>النوع</th><th>الأندية</th><th>نطاق التداخل</th><th>الأيام</th></tr></thead><tbody>`;
  let total = 0;
  conflicts.forEach(c=>{
    const s = formatDateDisplay(c.start), e = formatDateDisplay(c.end);
    const range = (s === e) ? s : `${s} - ${e}`;
    html += `<tr>
      <td class="conflict-type">${escapeHtml(c.type)}</td>
      <td>${escapeHtml(c.club1)} ⚔️ ${escapeHtml(c.club2)}</td>
      <td>${escapeHtml(range)}</td>
      <td class="conflict-days">${c.days} يوم</td>
    </tr>`;
    total += c.days;
  });
  html += `<tr style="background:#f8faf8;font-weight:700"><td colspan="3">مجموع أيام التعارضات</td><td>${total} يوم</td></tr>`;
  html += `</tbody>`;
  table.innerHTML = html;
  container.appendChild(table);
}

/* ================= التصدير / استيراد / مسح ================= */
function exportBackup(){
  const payload = { 
    version:'2.0', 
    exportDate: new Date().toISOString(), 
    clubs: clubsData.map(c=>{ const {editing,_backup,...rest}=c; return rest; }), 
    dropdownOptions: getDropdownOptions(),
    clubsReconciliation: clubsReconciliation,
    presidents: presidentsData
  };
  const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json;charset=utf-8'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = `backup-clubs-${new Date().toISOString().split('T')[0]}.json`; a.click();
  localStorage.setItem('lastBackup', new Date().toISOString()); updateLastBackupDisplay();
  alert('تم تصدير النسخة الاحتياطية');
}

function triggerImportBackup(){
  const input = document.createElement('input'); input.type='file'; input.accept='.json';
  input.onchange = ()=> {
    const file = input.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      try {
        const parsed = JSON.parse(e.target.result);
        if(Array.isArray(parsed)){
          if(!confirm('الملف يحتوي على مصفوفة أندية مباشرة. استبدال البيانات الحالية؟')) return;
          clubsData = parsed.map(normalizeClub);
        } else if(parsed && parsed.clubs){
          if(!confirm('الملف يبدو نسخة احتياطية. استبدال البيانات الحالية؟')) return;
          clubsData = parsed.clubs.map(normalizeClub);
          if(parsed.dropdownOptions && Array.isArray(parsed.dropdownOptions)){
            const select = document.getElementById('clubSelect');
            while(select.options.length>1) select.remove(1);
            parsed.dropdownOptions.forEach(name => { const opt=document.createElement('option'); opt.value=name; opt.text=name; select.add(opt); });
            saveDropdownOptions(parsed.dropdownOptions);
          }
          if(parsed.clubsReconciliation){
            clubsReconciliation = parsed.clubsReconciliation;
            saveReconciliationDates();
          }
          if(parsed.presidents && Array.isArray(parsed.presidents)){
            presidentsData = parsed.presidents;
            savePresidentsToStorage();
          }
        } else {
          alert('تنسيق الملف غير معروف. تأكد من أنه JSON بصيغة صحيحة.');
          return;
        }
        saveClubsToStorage(); 
        renderClubsTable(); 
        renderReconciliationTable();
        renderPresidentsTable();
        updatePresidentsStats();
        alert('تم استيراد البيانات بنجاح');
      } catch(err){
        alert('خطأ عند قراءة الملف: ' + err.message);
      }
    };
    reader.readAsText(file);
  };
  input.click();
}

function clearAllData(){
  if(!confirm('هل أنت متأكد من مسح جميع البيانات؟\n\nسيتم مسح:\n- مواعيد الأندية\n- تواريخ التوفيق\n- رؤساء الأندية')) return;
  clubsData = []; 
  clubsReconciliation = {};
  presidentsData = [];
  localStorage.removeItem('clubs'); 
  localStorage.removeItem('clubsReconciliation');
  localStorage.removeItem('presidents');
  localStorage.removeItem('dropdownOptions'); 
  ensureDropdownOptions();
  saveClubsToStorage(); 
  renderClubsTable(); 
  renderReconciliationTable();
  renderPresidentsTable();
  updatePresidentsStats();
  updateLastBackupDisplay(); 
  alert('تم مسح البيانات');
}

/* Simple CSV exporter (Excel ) */
function exportCSV(){
  const rows = [['اسم النادي','الانتخابات 1','الانتخابات 2','بداية التسديد','نهاية التسديد']];
  clubsData.forEach(c => rows.push([c.name || '', c.election1 || '', c.election2 || '', c.paymentStart || '', c.paymentEnd || '']));
  const csv = rows.map(r => r.map(cell => `"${(cell+'').replace(/"/g,'""')}"`).join(',')).join('\r\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `clubs-${new Date().toISOString().split('T')[0]}.csv`; a.click();
}

/* ================= المساعدة ================= */
function normalizeClub(obj){
  return {
    id: obj.id || Date.now() + Math.floor(Math.random()*10000),
    name: (obj.name || obj.title || obj.club || '').toString(),
    election1: obj.election1 || '',
    election2: obj.election2 || '',
    paymentStart: obj.paymentStart || '',
    paymentEnd: obj.paymentEnd || '',
    editing: false
  };
}

function parseDateSafe(s){
  if(!s) return null;
  // التعامل مع تنسيق YYYY-MM-DD مباشرة
  if(typeof s === 'string' && s.match(/^\d{4}-\d{2}-\d{2}$/)) {
    const parts = s.split('-');
    const year = parseInt(parts[0]);
    const month = parseInt(parts[1]) - 1; // الأشهر من 0-11
    const day = parseInt(parts[2]);
    return new Date(year, month, day);
  }
  if(s instanceof Date) return new Date(s.getFullYear(), s.getMonth(), s.getDate());
  const d = new Date(s); 
  return isNaN(d.getTime()) ? null : new Date(d.getFullYear(), d.getMonth(), d.getDate());
}
function dateToISO(d){ 
  if(!d) return '';
  const year = d.getFullYear();
  const month = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}
function formatDateDisplay(d){
  const dt = (d instanceof Date) ? d : parseDateSafe(d);
  if(!dt) return '';
  return `${String(dt.getDate()).padStart(2,'0')}/${String(dt.getMonth()+1).padStart(2,'0')}/${dt.getFullYear()}`;
}
function escapeHtml(s){ if(s===undefined || s===null) return ''; return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }

/* واجهة المستخدم */
function updateStats(){ document.getElementById('clubsCount').textContent = `${clubsData.length} نادي`; }
function updateLastBackupDisplay(){ const s = localStorage.getItem('lastBackup'); document.getElementById('lastBackup').textContent = s ? (new Date(s)).toLocaleString() : 'لا توجد'; }


function showModal(title, message, onConfirm){
  modalCallback = onConfirm;
  const modal = document.getElementById('confirmModal'); const box = modal.querySelector('.box');
  const prev = box.querySelector('#confirmText'); if(prev) prev.remove();
  const txt = document.createElement('div'); txt.id='confirmText'; txt.innerHTML = `<strong>${escapeHtml(title)}</strong><p style="margin-top:8px">${escapeHtml(message)}</p>`;
  box.insertBefore(txt, box.querySelector('.actions'));
  modal.style.display = 'flex';
}
function closeModal(confirmed){
  const modal = document.getElementById('confirmModal'); modal.style.display = 'none';
  if(confirmed && typeof modalCallback === 'function') modalCallback();
  modalCallback = null;
}

/* ================= الدورات الانتخابية ================= */

// تحميل بيانات الرؤساء من التخزين
function loadPresidentsFromStorage(){
  const s = localStorage.getItem('presidents');
  if(s){
    try{ presidentsData = JSON.parse(s); } catch(e){ presidentsData = []; }
  } else presidentsData = [];
}

// حفظ بيانات الرؤساء
function savePresidentsToStorage(){
  try{ localStorage.setItem('presidents', JSON.stringify(presidentsData)); } catch(e){}
  updatePresidentsStats();
}

// ملء قائمة الأندية في صفحة الرؤساء
function populatePresidentClubSelect(){
  const select = document.getElementById('presidentClubSelect');
  while(select.options.length > 1) select.remove(1);
  const clubs = getDropdownOptions();
  clubs.forEach(name => {
    const opt = document.createElement('option'); 
    opt.value = name; 
    opt.text = name; 
    select.add(opt);
  });
}

/* ================= وظائف تواريخ التوفيق ================= */

// تحميل تواريخ التوفيق من التخزين
function loadReconciliationDates(){
  try{
    const saved = localStorage.getItem('clubsReconciliation');
    if(saved) clubsReconciliation = JSON.parse(saved);
  }catch(e){}
}

// حفظ تواريخ التوفيق
function saveReconciliationDates(){
  try{
    localStorage.setItem('clubsReconciliation', JSON.stringify(clubsReconciliation));
  }catch(e){}
}

// ملء قائمة الأندية في قسم التوفيق
function populateReconciliationClubSelect(){
  const select = document.getElementById('clubSelectReconciliation');
  while(select.options.length > 1) select.remove(1);
  
  const clubs = getDropdownOptions();
  clubs.forEach(name => {
    const opt = document.createElement('option'); 
    opt.value = name; 
    opt.text = name; 
    select.add(opt);
  });
}

// حفظ تاريخ التوفيق لنادي
function setReconciliationDate(){
  const clubSelect = document.getElementById('clubSelectReconciliation');
  const dateInput = document.getElementById('reconciliationDateInput');
  
  const clubName = clubSelect.value;
  const dateValue = dateInput.value.trim();
  
  if(!clubName){ alert('الرجاء اختيار النادي'); return; }
  if(!dateValue){ alert('الرجاء إدخال تاريخ التوفيق'); return; }
  if(!isValidDate(dateValue)){ alert('تاريخ غير صحيح. الصيغة المطلوبة: يوم/شهر/سنة (مثال: 09/07/2009)'); return; }
  
  clubsReconciliation[clubName] = dateValue;
  saveReconciliationDates();
  renderReconciliationTable();
  
  // إعادة حساب أهلية جميع الرؤساء
  presidentsData.forEach(p => calculatePresidentEligibility(p));
  savePresidentsToStorage();
  renderPresidentsTable();
  
  dateInput.value = '';
  clubSelect.value = '';
  alert('تم حفظ تاريخ التوفيق بنجاح');
}

// حذف تاريخ التوفيق
function deleteReconciliationDate(clubName){
  if(!confirm(`هل تريد حذف تاريخ التوفيق لـ ${clubName}؟`)) return;
  
  delete clubsReconciliation[clubName];
  saveReconciliationDates();
  renderReconciliationTable();
  
  // إعادة حساب أهلية جميع الرؤساء
  presidentsData.forEach(p => calculatePresidentEligibility(p));
  savePresidentsToStorage();
  renderPresidentsTable();
  
  alert('تم حذف تاريخ التوفيق');
}

// عرض جدول تواريخ التوفيق
function renderReconciliationTable(){
  const tbody = document.querySelector('#reconciliationDatesTable tbody');
  tbody.innerHTML = '';
  
  const clubs = Object.keys(clubsReconciliation).sort();
  
  if(clubs.length === 0){
    tbody.innerHTML = '<tr><td colspan="3" class="muted">لا توجد تواريخ توفيق محفوظة</td></tr>';
    return;
  }
  
  clubs.forEach(clubName => {
    const date = clubsReconciliation[clubName];
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${clubName}</td>
      <td><strong>${date}</strong></td>
      <td class="actions">
        <button class="delete" onclick="deleteReconciliationDate('${clubName}')">🗑️ حذف</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

/* ================= وظائف مساعدة للتواريخ ================= */

// تحويل نص التاريخ إلى كائن Date
function parseDate(dateString){
  const parts = dateString.split('/');
  const day = parseInt(parts[0]);
  const month = parseInt(parts[1]) - 1;
  const year = parseInt(parts[2]);
  return new Date(year, month, day);
}

// التحقق من صحة التاريخ
function isValidDate(dateString){
  const regex = /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/;
  if(!regex.test(dateString)) return false;
  
  try{
    const date = parseDate(dateString);
    return date instanceof Date && !isNaN(date);
  }catch(e){
    return false;
  }
}

// مقارنة تاريخين
function compareDates(date1String, date2String){
  const d1 = parseDate(date1String);
  const d2 = parseDate(date2String);
  
  if(d1 < d2) return -1;
  if(d1 > d2) return 1;
  return 0;
}

// حساب الفرق بالأيام بين تاريخين
function getDaysDifference(startDateString, endDateString){
  const start = parseDate(startDateString);
  const end = parseDate(endDateString);
  
  const diffTime = end - start;
  const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
  
  return diffDays;
}

// حساب الفرق بالسنوات
function getYearsDifference(startDateString, endDateString){
  const start = parseDate(startDateString);
  const end = parseDate(endDateString);
  
  let years = end.getFullYear() - start.getFullYear();
  const monthDiff = end.getMonth() - start.getMonth();
  const dayDiff = end.getDate() - start.getDate();
  
  if(monthDiff < 0 || (monthDiff === 0 && dayDiff < 0)){
    years--;
  }
  
  return years;
}

// تنسيق التاريخ
function formatDate(date){
  const day = String(date.getDate()).padStart(2, '0');
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const year = date.getFullYear();
  return `${day}/${month}/${year}`;
}

// إضافة سنوات لتاريخ
function addYearsToDate(dateString, years){
  const date = parseDate(dateString);
  date.setFullYear(date.getFullYear() + years);
  return formatDate(date);
}

/* ================= وظائف الرؤساء ================= */

// إضافة رئيس جديد
function addNewPresident(){
  const nameInput = document.getElementById('presidentName');
  const clubSelect = document.getElementById('presidentClubSelect');
  const dateInput = document.getElementById('cycleStartDate');
  
  const name = nameInput.value.trim();
  const clubName = clubSelect.value;
  const startDate = dateInput.value.trim();
  
  if(!name){ alert('الرجاء إدخال اسم الرئيس'); return; }
  if(!clubName){ alert('الرجاء اختيار النادي'); return; }
  if(!startDate){ alert('الرجاء إدخال تاريخ بداية الدورة'); return; }
  if(!isValidDate(startDate)){ alert('تاريخ غير صحيح. الصيغة المطلوبة: يوم/شهر/سنة (مثال: 15/03/2022)'); return; }
  
  // التحقق من عدم وجود رئيس بنفس الاسم والنادي
  if(presidentsData.some(p => p.name === name && p.clubName === clubName)){
    alert('يوجد رئيس بنفس الاسم والنادي بالفعل');
    return;
  }
  
  const endDate = addYearsToDate(startDate, 3);
  
  const president = {
    id: Date.now() + Math.random(),
    name: name,
    clubName: clubName,
    cycles: [{
      cycleNumber: 1,
      startDate: startDate,
      endDate: endDate,
      status: 'current',
      countable: true
    }],
    totalCycles: 1,
    countableCycles: 1,
    consecutiveCycles: 1,
    canNominate: true,
    nextEligibleDate: null
  };
  
  calculatePresidentEligibility(president);
  presidentsData.push(president);
  savePresidentsToStorage();
  renderPresidentsTable();
  updatePresidentsStats();
  
  nameInput.value = '';
  clubSelect.value = '';
  dateInput.value = '';
  alert('تمت إضافة الرئيس بنجاح');
}

// حساب الدورات المتتالية المحسوبة
function calculateConsecutiveCycles(cycles){
  if(cycles.length === 0) return 0;
  
  // فلترة الدورات المحسوبة فقط
  const countableCycles = cycles.filter(c => c.countable);
  if(countableCycles.length === 0) return 0;
  
  // جميع الدورات المحسوبة تُعتبر متتالية
  // لأن المستخدم يُدخلها بالترتيب الزمني
  return countableCycles.length;
}

// تحديد الدورات المحسوبة بناءً على تاريخ التوفيق
function markCountableCycles(president){
  const reconciliationDate = clubsReconciliation[president.clubName];
  
  if(!reconciliationDate){
    // إذا لم يكن هناك تاريخ توفيق، جميع الدورات محسوبة
    president.cycles.forEach(cycle => {
      cycle.countable = true;
    });
    return;
  }
  
  president.cycles.forEach(cycle => {
    // الدورة محسوبة إذا بدأت في أو بعد تاريخ التوفيق
    cycle.countable = compareDates(cycle.startDate, reconciliationDate) >= 0;
  });
}

// حساب أهلية الترشح
function calculatePresidentEligibility(president){
  // تحديد الدورات المحسوبة
  markCountableCycles(president);
  
  // حساب الإحصائيات
  president.totalCycles = president.cycles.length;
  president.countableCycles = president.cycles.filter(c => c.countable).length;
  president.consecutiveCycles = calculateConsecutiveCycles(president.cycles);
  
  // التحقق من الحد الأقصى (3 دورات محسوبة)
  if(president.countableCycles >= 3){
    president.canNominate = false;
    president.nextEligibleDate = null;
    return;
  }
  
  // التحقق من الدورتين المتتاليتين
  if(president.consecutiveCycles >= 2){
    const lastCycle = president.cycles[president.cycles.length - 1];
    president.canNominate = false;
    president.nextEligibleDate = addYearsToDate(lastCycle.endDate, 3);
    return;
  }
  
  president.canNominate = true;
  president.nextEligibleDate = null;
}

// إضافة دورة جديدة
function addCycleToPresident(index){
  const president = presidentsData[index];
  
  // التحقق من الأهلية
  if(!president.canNominate){
    if(president.countableCycles >= 3){
      alert('⛔ لا يمكن إضافة دورة جديدة\n\nالسبب: وصل الرئيس للحد الأقصى (3 دورات محسوبة)');
      return;
    }
    if(president.consecutiveCycles >= 2){
      alert(`⛔ لا يمكن إضافة دورة جديدة\n\nالسبب: أكمل دورتين متتاليتين\nيجب الانقطاع دورة واحدة (3 سنوات)\nيحق له الترشح في تاريخ: ${president.nextEligibleDate}`);
      return;
    }
  }
  
  const lastCycle = president.cycles[president.cycles.length - 1];
  const startDate = prompt(`أدخل تاريخ بداية الدورة الجديدة (يوم/شهر/سنة):\n\n(آخر دورة انتهت في ${lastCycle.endDate})`, lastCycle.endDate);
  
  if(!startDate) return;
  
  if(!isValidDate(startDate)){
    alert('تاريخ غير صحيح. الصيغة المطلوبة: يوم/شهر/سنة (مثال: 15/03/2025)');
    return;
  }
  
  // التحقق من أن التاريخ ليس في الماضي البعيد
  // نسمح بإضافة دورة قبل نهاية الدورة السابقة بحد أقصى 30 يوماً
  const daysDiff = getDaysDifference(startDate, lastCycle.endDate);
  
  if(daysDiff < -30){
    alert(`⛔ لا يمكن إضافة دورة في الماضي\n\nتاريخ بداية الدورة الجديدة يجب أن يكون:\n- في نفس تاريخ نهاية الدورة السابقة (${lastCycle.endDate})\n- أو قبله بحد أقصى 30 يوماً\n\nملاحظة: يُسمح ببدء الدورة قبل انتهاء الدورة السابقة بـ 15-25 يوم لإجراء الانتخابات`);
    return;
  }
  
  // جميع الدورات المضافة تُعتبر متتالية
  // التحقق من عدم تجاوز دورتين متتاليتين
  if(president.consecutiveCycles >= 2){
    alert('⛔ لا يمكن إضافة دورة ثالثة متتالية\n\nيجب الانقطاع دورة واحدة على الأقل (عدم إضافة دورة جديدة)');
    return;
  }
  
  const endDate = addYearsToDate(startDate, 3);
  
  const newCycle = {
    cycleNumber: president.cycles.length + 1,
    startDate: startDate,
    endDate: endDate,
    status: 'current',
    countable: true
  };
  
  // تحديث حالة الدورة السابقة
  lastCycle.status = 'completed';
  
  president.cycles.push(newCycle);
  calculatePresidentEligibility(president);
  savePresidentsToStorage();
  renderPresidentsTable();
  updatePresidentsStats();
  alert('تمت إضافة الدورة بنجاح');
}

// عرض تفاصيل دورات الرئيس
function showPresidentCycles(index){
  const president = presidentsData[index];
  const modal = document.getElementById('cyclesModal');
  const title = document.getElementById('cyclesModalTitle');
  const content = document.getElementById('cyclesModalContent');
  
  title.textContent = `تفاصيل دورات: ${president.name} - ${president.clubName}`;
  
  const reconciliationDate = clubsReconciliation[president.clubName];
  
  let html = '<div style="margin-bottom:12px">';
  html += `<div style="display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap">`;
  html += `<span class="badge">إجمالي: ${president.totalCycles} دورات</span>`;
  html += `<span class="badge">محسوبة: ${president.countableCycles} دورات</span>`;
  html += `<span class="badge">متتالية: ${president.consecutiveCycles}</span>`;
  html += `</div>`;
  if(reconciliationDate){
    html += `<div style="font-size:13px;color:var(--muted)">📅 تاريخ توفيق النظام: <strong>${reconciliationDate}</strong></div>`;
  }
  html += '</div>';
  
  html += '<table style="width:100%;min-width:auto">';
  html += '<thead><tr><th>الدورة</th><th>تاريخ البداية</th><th>تاريخ النهاية</th><th>المدة</th><th>محسوبة؟</th><th>الحالة</th></tr></thead>';
  html += '<tbody>';
  
  president.cycles.forEach((cycle, i) => {
    const duration = getYearsDifference(cycle.startDate, cycle.endDate);
    const statusText = cycle.status === 'current' ? '🟢 حالية' : '✅ مكتملة';
    const countableText = cycle.countable ? '✅ نعم' : '❌ لا';
    
    // جميع الدورات المحسوبة تُعتبر متتالية
    const isConsecutive = (i > 0 && cycle.countable && president.cycles[i-1].countable);
    const consecutiveIcon = isConsecutive ? ' 🔗' : '';
    
    html += `<tr>`;
    html += `<td>${cycle.cycleNumber}${consecutiveIcon}</td>`;
    html += `<td>${cycle.startDate}</td>`;
    html += `<td>${cycle.endDate}</td>`;
    html += `<td>${duration} سنوات</td>`;
    html += `<td>${countableText}</td>`;
    html += `<td>${statusText}</td>`;
    html += `</tr>`;
  });
  
  html += '</tbody></table>';
  
  // إضافة مخطط زمني بصري
  html += '<div style="margin-top:16px;padding:12px;background:#f9fafb;border-radius:8px">';
  html += '<div style="font-weight:700;margin-bottom:8px">المخطط الزمني:</div>';
  html += '<div style="display:flex;gap:4px;flex-wrap:wrap">';
  
  president.cycles.forEach((cycle, i) => {
    // جميع الدورات المحسوبة تُعتبر متتالية
    // الانقطاع يظهر فقط بين دورة محسوبة ودورة غير محسوبة
    const isConsecutive = (i > 0 && cycle.countable && president.cycles[i-1].countable);
    
    const color = cycle.countable ? (cycle.status === 'current' ? '#10b981' : '#3b82f6') : '#9ca3af';
    
    // إظهار انقطاع فقط إذا كانت الدورة الحالية محسوبة والسابقة غير محسوبة
    if(i > 0 && cycle.countable && !president.cycles[i-1].countable){
      html += `<div style="padding:8px;background:#ef4444;color:#fff;border-radius:4px;font-size:12px">❌ انقطاع</div>`;
    }
    
    html += `<div style="padding:8px;background:${color};color:#fff;border-radius:4px;font-size:12px">`;
    html += `دورة ${cycle.cycleNumber}${cycle.countable ? '' : ' (غير محسوبة)'}<br>${cycle.startDate}<br>إلى<br>${cycle.endDate}`;
    html += `</div>`;
  });
  
  html += '</div></div>';
  
  content.innerHTML = html;
  modal.style.display = 'flex';
}

function closeCyclesModal(){
  document.getElementById('cyclesModal').style.display = 'none';
}

// حذف رئيس
function deletePresident(index){
  const president = presidentsData[index];
  showModal('تأكيد الحذف', `هل تريد حذف الرئيس "${president.name}" من نادي "${president.clubName}"؟`, ()=>{
    presidentsData.splice(index, 1);
    savePresidentsToStorage();
    renderPresidentsTable();
    alert('تم حذف الرئيس');
  });
}

// عرض جدول الرؤساء
function renderPresidentsTable(){
  const tbody = document.querySelector('#presidentsTable tbody');
  tbody.innerHTML = '';
  
  if(presidentsData.length === 0){
    tbody.innerHTML = '<tr><td colspan="8" style="padding:20px;color:var(--muted)">لا توجد بيانات. أضف رئيس نادي جديد</td></tr>';
    return;
  }
  
  presidentsData.forEach((president, i) => {
    const tr = document.createElement('tr');
    
    const eligibilityText = president.canNominate ? '✅ يحق له' : '⛔ لا يحق له';
    const eligibilityColor = president.canNominate ? '#16a34a' : '#ef4444';
    
    const nextDateText = president.nextEligibleDate ? president.nextEligibleDate : '-';
    
    tr.innerHTML = `
      <td>${escapeHtml(president.name)}</td>
      <td>${escapeHtml(president.clubName)}</td>
      <td><span class="badge">${president.totalCycles}</span></td>
      <td><span class="badge">${president.countableCycles}</span></td>
      <td><span class="badge">${president.consecutiveCycles}</span></td>
      <td style="color:${eligibilityColor};font-weight:700">${eligibilityText}</td>
      <td>${nextDateText}</td>
      <td class="actions">
        <button class="edit" onclick="addCycleToPresident(${i})" title="إضافة دورة">➕</button>
        <button class="save" onclick="showPresidentCycles(${i})" title="عرض التفاصيل">📋</button>
        <button class="delete" onclick="deletePresident(${i})" title="حذف">🗑️</button>
      </td>
    `;
    
    tbody.appendChild(tr);
  });
}

// تحديث الإحصائيات
function updatePresidentsStats(){
  const total = presidentsData.length;
  const eligible = presidentsData.filter(p => p.canNominate).length;
  const ineligible = total - eligible;
  
  document.getElementById('presidentsCount').textContent = `${total} رئيس`;
  document.getElementById('eligibleCount').textContent = `${eligible} مؤهل`;
  document.getElementById('ineligibleCount').textContent = `${ineligible} ممنوع`;
}

/*  الوظائف و وحدة التحكم */
window._save = saveClubsToStorage;
window._load = loadClubsFromStorage;
window._savePresidents = savePresidentsToStorage;
window._loadPresidents = loadPresidentsFromStorage;

</script>
</body>
</html>



